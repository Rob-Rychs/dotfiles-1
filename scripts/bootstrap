#!/usr/bin/env bash

export DOTFILES=~/.dotfiles

backup_dir="$DOTFILES/backup/$(date "+%Y_%m_%d-%H_%M_%S")/"
DEFAULT_NAME="Lars Graubner"
DEFAULT_EMAIL="mail@larsgraubner.de"
NAME=""
EMAIL=""

source $DOTFILES/scripts/utils.sh

_setup_git() {
    e_header "Set up gitconfig"
    sed -e "s/AUTHORNAME/$NAME/g" -e "s/AUTHOREMAIL/$EMAIL/g" $DOTFILES/git/gitconfig.symlink.example > $DOTFILES/git/gitconfig.symlink
    e_success
}

_install_node() {
    e_header "Install Node.js"
    curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.31.4/install.sh | bash

    export NVM_DIR="/Users/larsgraubner/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"

    nvm install stable
    nvm use stable
    nvm alias default stable

    e_header "Set node publisher information"
    npm set init.author.name "$NAME"
    npm set init.author.email "$EMAIL"
    npm set init.author.url "$SITE"
    npm set save-exact true
    npm adduser
}

_link_files() {
    e_header 'Link dotfiles'

    find -H "$DOTFILES" -maxdepth 2 -iname "*.symlink" | while read src; do
        dst="$HOME/.$(basename "${src%.*}")"
        if [[ -e "$dst" ]]; then
            e_line "Backing up ${dst/#$HOME\//}"

            [[ -e "$backup_dir" ]] || mkdir -p "$backup_dir"
            mv "$dst" "$backup_dir"
        fi
        ln -s "$src" "$dst"
        e_line "Linked ${src/#$HOME/~} to ${dst/#$HOME/~}"
    done

    if [[ -e $backup_dir ]]; then
        e_line "\nBackups were moved to ${backup_dir/#$HOME/~}"
    fi

    e_success
}

init() {
    e_header "Administrator privileges will be required..."
    sudo -v

    read -p "Author Name ($DEFAULT_NAME): " name
    NAME=${name:-$DEFAULT_NAME}
    read -p "Author E-Mail ($DEFAULT_EMAIL): " email
    EMAIL=${email:-$DEFAULT_EMAIL}

    # setup git
    _setup_git

    # link dotfiles
    _link_files

    # install npm
    _install_node

    # reload shell
    exec /bin/zsh -l
}

cat <<HELP
Dotfiles - Lars Graubner - http://larsgraubner.de

Usage: dotfiles {install|update|upgrade}

See the README for documentation.
https://github.com/lgraubner/dotfiles

Copyright (c) 2015 Lars Graubner
Licensed under the MIT license.
HELP

init

exit 0
