#!/usr/bin/env bash
#
# Manages the dotfiles.
#
# USAGE:
#
#   $ dotfiles {install|update|upgrade}
#

set -e

if [[ -z "$1" || "$1" == "-h" || "$1" == "--help" ]]; then cat <<HELP
Dotfiles - Lars Graubner - http://larsgraubner.de

Usage: $(basename "$0") {install|update|upgrade}

See the README for documentation.
https://github.com/lgraubner/dotfiles

Copyright (c) 2015 Lars Graubner
Licensed under the MIT license.
HELP
exit; fi

export DOTFILES=~/.dotfiles

source $DOTFILES/scripts/utils.sh

install() {
    # find installers and run them iteratively
    find $DOTFILES -name install.sh | while read installer ; do sh -c "${installer}" ; done
}

update() {
    # extend sudo timeout
    sudo -v

    if [Â -n "$2" ]; then
        updater=$(find $DOTFILES/$2 -name update.sh 2>&1)

        # exit if file does not exist
        if [[ -ef ${updater} ]]; then
            sh -c "${updater}"
        else
            echo "Update script not found"
            exit 1
        fi

        sh -c "${updater}"
    else
        # find updaters and run them iteratively
        find $DOTFILES -name update.sh | while read updater ; do sh -c "${updater}" ; done
    fi
}

upgrade() {
    e_header "Upgrading dotfiles"

    ( cd $DOTFILES && git reset --hard HEAD && git pull )

    e_success "dotfiles upgraded"
    e_header "All done!"

    # reload shell
    exec /bin/zsh -l
}

case $1 in
    install)
        install
        ;;
    update)
        update
        ;;
    upgrade)
        upgrade
        ;;
    *)
        exit 1
esac

e_header "All done!"
