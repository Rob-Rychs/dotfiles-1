Object.defineProperty(exports, '__esModule', {
  value: true
});
exports.focusEditor = focusEditor;
exports.replaceTag = replaceTag;
exports.replaceTags = replaceTags;
exports.formatType = formatType;
exports.prepareType = prepareType;
exports.prepareInlineDocs = prepareInlineDocs;
exports.buildDisplayText = buildDisplayText;
exports.buildSnippet = buildSnippet;
exports.extractParams = extractParams;
exports.formatTypeCompletion = formatTypeCompletion;
exports.disposeAll = disposeAll;
exports.openFileAndGoToPosition = openFileAndGoToPosition;
exports.openFileAndGoTo = openFileAndGoTo;
exports.updateTernFile = updateTernFile;
exports.writeFile = writeFile;
exports.isDirectory = isDirectory;
exports.fileExists = fileExists;
exports.getFileContent = getFileContent;
exports.readFile = readFile;
exports.setMarkerCheckpoint = setMarkerCheckpoint;
exports.markerCheckpointBack = markerCheckpointBack;
exports.markDefinitionBufferRange = markDefinitionBufferRange;

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

var _atomTernjsManager = require('./atom-ternjs-manager');

var _atomTernjsManager2 = _interopRequireDefault(_atomTernjsManager);

var _atomTernjsPackageConfig = require('./atom-ternjs-package-config');

var _atomTernjsPackageConfig2 = _interopRequireDefault(_atomTernjsPackageConfig);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

'use babel';

var checkpointsDefinition = [];

var tags = {

  '&': '&amp;',
  '<': '&lt;',
  '>': '&gt;'
};

var accessKey = 'altKey';

exports.accessKey = accessKey;

function focusEditor() {

  var editor = atom.workspace.getActiveTextEditor();

  if (!editor) {

    return;
  }

  var view = atom.views.getView(editor);

  view && view.focus && view.focus();
}

function replaceTag(tag) {

  return tags[tag];
}

function replaceTags(str) {

  if (!str) {

    return '';
  }

  return str.replace(/[&<>]/g, replaceTag);
}

function formatType(data) {

  if (!data.type) {

    return '';
  }

  data.type = data.type.replace(/->/g, ':').replace('<top>', 'window');

  if (!data.exprName) {

    return data.type;
  }

  data.type = data.type.replace(/^fn/, data.exprName);

  return data.type;
}

function prepareType(data) {

  if (!data.type) {

    return;
  }

  return data.type.replace(/->/g, ':').replace('<top>', 'window');
}

function prepareInlineDocs(data) {

  return data.replace(/@param/, '<span class="doc-param-first">@param</span>').replace(/@param/g, '<span class="storage type doc-param">@param</span>').replace(/@return/, '<span class="storage type doc-return">@return</span>');
}

function buildDisplayText(params, name) {

  if (params.length === 0) {

    return name + '()';
  }

  var suggestionParams = params.map(function (param) {

    param = param.replace('}', '\\}');
    param = param.replace(/'"/g, '');

    return param;
  });

  return name + '(' + suggestionParams.join(',') + ')';
}

function buildSnippet(params, name) {

  if (params.length === 0) {

    return name + '()';
  }

  var suggestionParams = params.map(function (param, i) {

    param = param.replace('}', '\\}');

    return '${' + (i + 1) + ':' + param + '}';
  });

  return name + '(' + suggestionParams.join(',') + ')';
}

function extractParams(type) {

  if (!type) {

    return [];
  }

  var start = type.indexOf('(') + 1;
  var params = [];
  var inside = 0;

  for (var i = start; i < type.length; i++) {

    if (type[i] === ':' && inside === -1) {

      params.push(type.substring(start, i - 2));

      break;
    }

    if (i === type.length - 1) {

      var param = type.substring(start, i);

      if (param.length) {

        params.push(param);
      }

      break;
    }

    if (type[i] === ',' && inside === 0) {

      params.push(type.substring(start, i));
      start = i + 1;

      continue;
    }

    if (type[i].match(/[{\[\(]/)) {

      inside++;

      continue;
    }

    if (type[i].match(/[}\]\)]/)) {

      inside--;
    }
  }

  return params;
}

function formatTypeCompletion(obj, isProperty, isObjectKey, isInFunDef) {

  if (obj.isKeyword) {

    obj._typeSelf = 'keyword';
  }

  if (obj.type === 'string') {

    obj.name = obj.name ? obj.name.replace(/(^"|"$)/g, '') : null;
  } else {

    obj.name = obj.name ? obj.name.replace(/["']/g, '') : null;
    obj.name = obj.name ? obj.name.replace(/^..\//, '') : null;
  }

  if (!obj.type) {

    obj._displayText = obj.name;
    obj._snippet = obj.name;

    return obj;
  }

  if (!obj.type.startsWith('fn')) {

    if (isProperty) {

      obj._typeSelf = 'property';
    } else {

      obj._typeSelf = 'variable';
    }
  }

  obj.type = obj.rightLabel = prepareType(obj);

  if (obj.type.replace(/fn\(.+\)/, '').length === 0) {

    obj.leftLabel = '';
  } else {

    if (obj.type.indexOf('fn') === -1) {

      obj.leftLabel = obj.type;
    } else {

      obj.leftLabel = obj.type.replace(/fn\(.{0,}\)/, '').replace(' : ', '');
    }
  }

  if (obj.rightLabel.startsWith('fn')) {

    var params = extractParams(obj.rightLabel);

    if (_atomTernjsPackageConfig2['default'].options.useSnippets || _atomTernjsPackageConfig2['default'].options.useSnippetsAndFunction) {

      if (!isInFunDef) {

        obj._snippet = buildSnippet(params, obj.name);
      }

      obj._hasParams = params.length ? true : false;
    } else {

      if (!isInFunDef) {

        obj._snippet = params.length ? obj.name + '(${' + 0 + ':${}})' : obj.name + '()';
      }

      obj._displayText = buildDisplayText(params, obj.name);
    }

    obj._typeSelf = 'function';
  }

  if (obj.name) {

    if (obj.leftLabel === obj.name) {

      obj.leftLabel = null;
      obj.rightLabel = null;
    }
  }

  if (obj.leftLabel === obj.rightLabel) {

    obj.rightLabel = null;
  }

  return obj;
}

function disposeAll(disposables) {

  for (var disposable of disposables) {

    if (!disposable) {

      continue;
    }

    disposable.dispose();
  }
}

function openFileAndGoToPosition(position, file) {

  atom.workspace.open(file).then(function (textEditor) {

    var cursor = textEditor.getLastCursor();

    if (!cursor) {

      return;
    }

    cursor.setBufferPosition(position);
  });
}

function openFileAndGoTo(start, file) {

  atom.workspace.open(file).then(function (textEditor) {

    var buffer = textEditor.getBuffer();
    var cursor = textEditor.getLastCursor();

    if (!buffer || !cursor) {

      return;
    }

    cursor.setBufferPosition(buffer.positionForCharacterIndex(start));
    markDefinitionBufferRange(cursor, textEditor);
  });
}

function updateTernFile(content, restartServer) {

  var projectRoot = _atomTernjsManager2['default'].server && _atomTernjsManager2['default'].server.projectDir;

  if (!projectRoot) {

    return;
  }

  writeFile(_path2['default'].resolve(__dirname, projectRoot + '/.tern-project'), content, restartServer);
}

function writeFile(filePath, content, restartServer) {

  _fs2['default'].writeFile(filePath, content, function (error) {

    atom.workspace.open(filePath);

    if (!error && restartServer) {

      _atomTernjsManager2['default'].restartServer();
    }

    if (!error) {

      return;
    }

    var message = 'Could not create/update .tern-project file. Use the README to manually create a .tern-project file.';

    atom.notifications.addInfo(message, {

      dismissable: true
    });
  });
}

function isDirectory(dir) {

  try {

    return _fs2['default'].statSync(dir).isDirectory();
  } catch (error) {

    return false;
  }
}

function fileExists(path) {

  try {

    _fs2['default'].accessSync(path, _fs2['default'].F_OK, function (error) {

      console.error(error);
    });
  } catch (error) {

    return false;
  }
}

function getFileContent(filePath, root) {

  var _filePath = root + filePath;
  var resolvedPath = _path2['default'].resolve(__dirname, _filePath);

  if (fileExists(resolvedPath) !== undefined) {

    return false;
  }

  return readFile(resolvedPath);
}

function readFile(path) {

  return _fs2['default'].readFileSync(path, 'utf8');
}

function setMarkerCheckpoint() {

  var editor = atom.workspace.getActiveTextEditor();
  var buffer = editor.getBuffer();
  var cursor = editor.getLastCursor();

  if (!cursor) {

    return;
  }

  var marker = buffer.markPosition(cursor.getBufferPosition(), {});

  checkpointsDefinition.push({

    marker: marker,
    editor: editor
  });
}

function markerCheckpointBack() {

  if (!checkpointsDefinition.length) {

    return;
  }

  var checkpoint = checkpointsDefinition.pop();

  openFileAndGoToPosition(checkpoint.marker.getRange().start, checkpoint.editor.getURI());
}

function markDefinitionBufferRange(cursor, editor) {

  var range = cursor.getCurrentWordBufferRange();
  var marker = editor.markBufferRange(range, { invalidate: 'touch' });

  var decoration = editor.decorateMarker(marker, {

    type: 'highlight',
    'class': 'atom-ternjs-definition-marker',
    invalidate: 'touch'
  });

  if (!decoration) {

    return;
  }

  setTimeout(function () {

    decoration.setProperties({

      type: 'highlight',
      'class': 'atom-ternjs-definition-marker active',
      invalidate: 'touch'
    });
  }, 1);

  setTimeout(function () {

    decoration.setProperties({

      type: 'highlight',
      'class': 'atom-ternjs-definition-marker',
      invalidate: 'touch'
    });
  }, 1501);

  setTimeout(function () {

    marker.destroy();
  }, 2500);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9sYXJzZ3JhdWJuZXIvLmRvdGZpbGVzL2RvdGZpbGVzLy5hdG9tL3BhY2thZ2VzL2F0b20tdGVybmpzL2xpYi9hdG9tLXRlcm5qcy1oZWxwZXIuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztpQ0FFb0IsdUJBQXVCOzs7O3VDQUNqQiw4QkFBOEI7Ozs7b0JBQ3ZDLE1BQU07Ozs7a0JBQ1IsSUFBSTs7OztBQUxuQixXQUFXLENBQUM7O0FBT1osSUFBSSxxQkFBcUIsR0FBRyxFQUFFLENBQUM7O0FBRS9CLElBQU0sSUFBSSxHQUFHOztBQUVYLEtBQUcsRUFBRSxPQUFPO0FBQ1osS0FBRyxFQUFFLE1BQU07QUFDWCxLQUFHLEVBQUUsTUFBTTtDQUNaLENBQUM7O0FBRUssSUFBTSxTQUFTLEdBQUcsUUFBUSxDQUFDOzs7O0FBRTNCLFNBQVMsV0FBVyxHQUFHOztBQUU1QixNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLG1CQUFtQixFQUFFLENBQUM7O0FBRXBELE1BQUksQ0FBQyxNQUFNLEVBQUU7O0FBRVgsV0FBTztHQUNSOztBQUVELE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDOztBQUV4QyxNQUFJLElBQUksSUFBSSxDQUFDLEtBQUssSUFBSSxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7Q0FDcEM7O0FBRU0sU0FBUyxVQUFVLENBQUMsR0FBRyxFQUFFOztBQUU5QixTQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztDQUNsQjs7QUFFTSxTQUFTLFdBQVcsQ0FBQyxHQUFHLEVBQUU7O0FBRS9CLE1BQUksQ0FBQyxHQUFHLEVBQUU7O0FBRVIsV0FBTyxFQUFFLENBQUM7R0FDWDs7QUFFRCxTQUFPLEdBQUcsQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFLFVBQVUsQ0FBQyxDQUFDO0NBQzFDOztBQUVNLFNBQVMsVUFBVSxDQUFDLElBQUksRUFBRTs7QUFFL0IsTUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUU7O0FBRWQsV0FBTyxFQUFFLENBQUM7R0FDWDs7QUFFRCxNQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLFFBQVEsQ0FBQyxDQUFDOztBQUVyRSxNQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRTs7QUFFbEIsV0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDO0dBQ2xCOztBQUVELE1BQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQzs7QUFFcEQsU0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDO0NBQ2xCOztBQUVNLFNBQVMsV0FBVyxDQUFDLElBQUksRUFBRTs7QUFFaEMsTUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUU7O0FBRWQsV0FBTztHQUNSOztBQUVELFNBQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsUUFBUSxDQUFDLENBQUM7Q0FDakU7O0FBRU0sU0FBUyxpQkFBaUIsQ0FBQyxJQUFJLEVBQUU7O0FBRXRDLFNBQU8sSUFBSSxDQUNSLE9BQU8sQ0FBQyxRQUFRLEVBQUUsNkNBQTZDLENBQUMsQ0FDaEUsT0FBTyxDQUFDLFNBQVMsRUFBRSxvREFBb0QsQ0FBQyxDQUN4RSxPQUFPLENBQUMsU0FBUyxFQUFFLHNEQUFzRCxDQUFDLENBQzFFO0NBQ0o7O0FBRU0sU0FBUyxnQkFBZ0IsQ0FBQyxNQUFNLEVBQUUsSUFBSSxFQUFFOztBQUU3QyxNQUFJLE1BQU0sQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFOztBQUV2QixXQUFVLElBQUksUUFBSztHQUNwQjs7QUFFRCxNQUFJLGdCQUFnQixHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQUMsVUFBQyxLQUFLLEVBQUs7O0FBRTNDLFNBQUssR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsQ0FBQztBQUNsQyxTQUFLLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7O0FBRWpDLFdBQU8sS0FBSyxDQUFDO0dBQ2QsQ0FBQyxDQUFDOztBQUVILFNBQVUsSUFBSSxTQUFJLGdCQUFnQixDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsT0FBSTtDQUNqRDs7QUFFTSxTQUFTLFlBQVksQ0FBQyxNQUFNLEVBQUUsSUFBSSxFQUFFOztBQUV6QyxNQUFJLE1BQU0sQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFOztBQUV2QixXQUFVLElBQUksUUFBSztHQUNwQjs7QUFFRCxNQUFJLGdCQUFnQixHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQUMsVUFBQyxLQUFLLEVBQUUsQ0FBQyxFQUFLOztBQUU5QyxTQUFLLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUM7O0FBRWxDLG1CQUFhLENBQUMsR0FBRyxDQUFDLENBQUEsU0FBSSxLQUFLLE9BQUk7R0FDaEMsQ0FBQyxDQUFDOztBQUVILFNBQVUsSUFBSSxTQUFJLGdCQUFnQixDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsT0FBSTtDQUNqRDs7QUFFTSxTQUFTLGFBQWEsQ0FBQyxJQUFJLEVBQUU7O0FBRWxDLE1BQUksQ0FBQyxJQUFJLEVBQUU7O0FBRVQsV0FBTyxFQUFFLENBQUM7R0FDWDs7QUFFRCxNQUFJLEtBQUssR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUNsQyxNQUFJLE1BQU0sR0FBRyxFQUFFLENBQUM7QUFDaEIsTUFBSSxNQUFNLEdBQUcsQ0FBQyxDQUFDOztBQUVmLE9BQUssSUFBSSxDQUFDLEdBQUcsS0FBSyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFOztBQUV4QyxRQUFJLElBQUksQ0FBQyxDQUFDLENBQUMsS0FBSyxHQUFHLElBQUksTUFBTSxLQUFLLENBQUMsQ0FBQyxFQUFFOztBQUVwQyxZQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDOztBQUUxQyxZQUFNO0tBQ1A7O0FBRUQsUUFBSSxDQUFDLEtBQUssSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7O0FBRXpCLFVBQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDOztBQUV2QyxVQUFJLEtBQUssQ0FBQyxNQUFNLEVBQUU7O0FBRWhCLGNBQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7T0FDcEI7O0FBRUQsWUFBTTtLQUNQOztBQUVELFFBQUksSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLEdBQUcsSUFBSSxNQUFNLEtBQUssQ0FBQyxFQUFFOztBQUVuQyxZQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDdEMsV0FBSyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7O0FBRWQsZUFBUztLQUNWOztBQUVELFFBQUksSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsRUFBRTs7QUFFNUIsWUFBTSxFQUFFLENBQUM7O0FBRVQsZUFBUztLQUNWOztBQUVELFFBQUksSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsRUFBRTs7QUFFNUIsWUFBTSxFQUFFLENBQUM7S0FDVjtHQUNGOztBQUVELFNBQU8sTUFBTSxDQUFDO0NBQ2Y7O0FBRU0sU0FBUyxvQkFBb0IsQ0FBQyxHQUFHLEVBQUUsVUFBVSxFQUFFLFdBQVcsRUFBRSxVQUFVLEVBQUU7O0FBRTdFLE1BQUksR0FBRyxDQUFDLFNBQVMsRUFBRTs7QUFFakIsT0FBRyxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUM7R0FDM0I7O0FBRUQsTUFBSSxHQUFHLENBQUMsSUFBSSxLQUFLLFFBQVEsRUFBRTs7QUFFekIsT0FBRyxDQUFDLElBQUksR0FBRyxHQUFHLENBQUMsSUFBSSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsRUFBRSxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUM7R0FFL0QsTUFBTTs7QUFFTCxPQUFHLENBQUMsSUFBSSxHQUFHLEdBQUcsQ0FBQyxJQUFJLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQztBQUMzRCxPQUFHLENBQUMsSUFBSSxHQUFHLEdBQUcsQ0FBQyxJQUFJLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQztHQUM1RDs7QUFFRCxNQUFJLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRTs7QUFFYixPQUFHLENBQUMsWUFBWSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUM7QUFDNUIsT0FBRyxDQUFDLFFBQVEsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDOztBQUV4QixXQUFPLEdBQUcsQ0FBQztHQUNaOztBQUVELE1BQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsRUFBRTs7QUFFOUIsUUFBSSxVQUFVLEVBQUU7O0FBRWQsU0FBRyxDQUFDLFNBQVMsR0FBRyxVQUFVLENBQUM7S0FFNUIsTUFBTTs7QUFFTCxTQUFHLENBQUMsU0FBUyxHQUFHLFVBQVUsQ0FBQztLQUM1QjtHQUNGOztBQUVELEtBQUcsQ0FBQyxJQUFJLEdBQUcsR0FBRyxDQUFDLFVBQVUsR0FBRyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUM7O0FBRTdDLE1BQUksR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxFQUFFLEVBQUUsQ0FBQyxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7O0FBRWpELE9BQUcsQ0FBQyxTQUFTLEdBQUcsRUFBRSxDQUFDO0dBRXBCLE1BQU07O0FBRUwsUUFBSSxHQUFHLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRTs7QUFFakMsU0FBRyxDQUFDLFNBQVMsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDO0tBRTFCLE1BQU07O0FBRUwsU0FBRyxDQUFDLFNBQVMsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxhQUFhLEVBQUUsRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztLQUN4RTtHQUNGOztBQUVELE1BQUksR0FBRyxDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLEVBQUU7O0FBRW5DLFFBQUksTUFBTSxHQUFHLGFBQWEsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUM7O0FBRTNDLFFBQ0UscUNBQWMsT0FBTyxDQUFDLFdBQVcsSUFDakMscUNBQWMsT0FBTyxDQUFDLHNCQUFzQixFQUM1Qzs7QUFFQSxVQUFJLENBQUMsVUFBVSxFQUFFOztBQUVmLFdBQUcsQ0FBQyxRQUFRLEdBQUcsWUFBWSxDQUFDLE1BQU0sRUFBRSxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7T0FDL0M7O0FBRUQsU0FBRyxDQUFDLFVBQVUsR0FBRyxNQUFNLENBQUMsTUFBTSxHQUFHLElBQUksR0FBRyxLQUFLLENBQUM7S0FFL0MsTUFBTTs7QUFFTCxVQUFJLENBQUMsVUFBVSxFQUFFOztBQUVmLFdBQUcsQ0FBQyxRQUFRLEdBQUcsTUFBTSxDQUFDLE1BQU0sR0FBTSxHQUFHLENBQUMsSUFBSSxXQUFPLENBQUMsY0FBZSxHQUFHLENBQUMsSUFBSSxPQUFJLENBQUM7T0FDL0U7O0FBRUQsU0FBRyxDQUFDLFlBQVksR0FBRyxnQkFBZ0IsQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO0tBQ3ZEOztBQUVELE9BQUcsQ0FBQyxTQUFTLEdBQUcsVUFBVSxDQUFDO0dBQzVCOztBQUVELE1BQUksR0FBRyxDQUFDLElBQUksRUFBRTs7QUFFWixRQUFJLEdBQUcsQ0FBQyxTQUFTLEtBQUssR0FBRyxDQUFDLElBQUksRUFBRTs7QUFFOUIsU0FBRyxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUM7QUFDckIsU0FBRyxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUM7S0FDdkI7R0FDRjs7QUFFRCxNQUFJLEdBQUcsQ0FBQyxTQUFTLEtBQUssR0FBRyxDQUFDLFVBQVUsRUFBRTs7QUFFcEMsT0FBRyxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUM7R0FDdkI7O0FBRUQsU0FBTyxHQUFHLENBQUM7Q0FDWjs7QUFFTSxTQUFTLFVBQVUsQ0FBQyxXQUFXLEVBQUU7O0FBRXRDLE9BQUssSUFBTSxVQUFVLElBQUksV0FBVyxFQUFFOztBQUVwQyxRQUFJLENBQUMsVUFBVSxFQUFFOztBQUVmLGVBQVM7S0FDVjs7QUFFRCxjQUFVLENBQUMsT0FBTyxFQUFFLENBQUM7R0FDdEI7Q0FDRjs7QUFFTSxTQUFTLHVCQUF1QixDQUFDLFFBQVEsRUFBRSxJQUFJLEVBQUU7O0FBRXRELE1BQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFDLFVBQVUsRUFBSzs7QUFFN0MsUUFBTSxNQUFNLEdBQUcsVUFBVSxDQUFDLGFBQWEsRUFBRSxDQUFDOztBQUUxQyxRQUFJLENBQUMsTUFBTSxFQUFFOztBQUVYLGFBQU87S0FDUjs7QUFFRCxVQUFNLENBQUMsaUJBQWlCLENBQUMsUUFBUSxDQUFDLENBQUM7R0FDcEMsQ0FBQyxDQUFDO0NBQ0o7O0FBRU0sU0FBUyxlQUFlLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRTs7QUFFM0MsTUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQUMsVUFBVSxFQUFLOztBQUU3QyxRQUFNLE1BQU0sR0FBRyxVQUFVLENBQUMsU0FBUyxFQUFFLENBQUM7QUFDdEMsUUFBTSxNQUFNLEdBQUcsVUFBVSxDQUFDLGFBQWEsRUFBRSxDQUFDOztBQUUxQyxRQUNFLENBQUMsTUFBTSxJQUNQLENBQUMsTUFBTSxFQUNQOztBQUVBLGFBQU87S0FDUjs7QUFFRCxVQUFNLENBQUMsaUJBQWlCLENBQUMsTUFBTSxDQUFDLHlCQUF5QixDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7QUFDbEUsNkJBQXlCLENBQUMsTUFBTSxFQUFFLFVBQVUsQ0FBQyxDQUFDO0dBQy9DLENBQUMsQ0FBQztDQUNKOztBQUVNLFNBQVMsY0FBYyxDQUFDLE9BQU8sRUFBRSxhQUFhLEVBQUU7O0FBRXJELE1BQU0sV0FBVyxHQUFHLCtCQUFRLE1BQU0sSUFBSSwrQkFBUSxNQUFNLENBQUMsVUFBVSxDQUFDOztBQUVoRSxNQUFJLENBQUMsV0FBVyxFQUFFOztBQUVoQixXQUFPO0dBQ1I7O0FBRUQsV0FBUyxDQUFDLGtCQUFLLE9BQU8sQ0FBQyxTQUFTLEVBQUUsV0FBVyxHQUFHLGdCQUFnQixDQUFDLEVBQUUsT0FBTyxFQUFFLGFBQWEsQ0FBQyxDQUFDO0NBQzVGOztBQUVNLFNBQVMsU0FBUyxDQUFDLFFBQVEsRUFBRSxPQUFPLEVBQUUsYUFBYSxFQUFFOztBQUUxRCxrQkFBRyxTQUFTLENBQUMsUUFBUSxFQUFFLE9BQU8sRUFBRSxVQUFDLEtBQUssRUFBSzs7QUFFekMsUUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7O0FBRTlCLFFBQUksQ0FBQyxLQUFLLElBQUksYUFBYSxFQUFFOztBQUUzQixxQ0FBUSxhQUFhLEVBQUUsQ0FBQztLQUN6Qjs7QUFFRCxRQUFJLENBQUMsS0FBSyxFQUFFOztBQUVWLGFBQU87S0FDUjs7QUFFRCxRQUFNLE9BQU8sR0FBRyxxR0FBcUcsQ0FBQzs7QUFFdEgsUUFBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFOztBQUVsQyxpQkFBVyxFQUFFLElBQUk7S0FDbEIsQ0FBQyxDQUFDO0dBQ0osQ0FBQyxDQUFDO0NBQ0o7O0FBRU0sU0FBUyxXQUFXLENBQUMsR0FBRyxFQUFFOztBQUUvQixNQUFJOztBQUVGLFdBQU8sZ0JBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDO0dBRXZDLENBQUMsT0FBTyxLQUFLLEVBQUU7O0FBRWQsV0FBTyxLQUFLLENBQUM7R0FDZDtDQUNGOztBQUVNLFNBQVMsVUFBVSxDQUFDLElBQUksRUFBRTs7QUFFL0IsTUFBSTs7QUFFRixvQkFBRyxVQUFVLENBQUMsSUFBSSxFQUFFLGdCQUFHLElBQUksRUFBRSxVQUFDLEtBQUssRUFBSzs7QUFFdEMsYUFBTyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztLQUN0QixDQUFDLENBQUM7R0FFSixDQUFDLE9BQU8sS0FBSyxFQUFFOztBQUVkLFdBQU8sS0FBSyxDQUFDO0dBQ2Q7Q0FDRjs7QUFFTSxTQUFTLGNBQWMsQ0FBQyxRQUFRLEVBQUUsSUFBSSxFQUFFOztBQUU3QyxNQUFNLFNBQVMsR0FBRyxJQUFJLEdBQUcsUUFBUSxDQUFDO0FBQ2xDLE1BQU0sWUFBWSxHQUFHLGtCQUFLLE9BQU8sQ0FBQyxTQUFTLEVBQUUsU0FBUyxDQUFDLENBQUM7O0FBRXhELE1BQUksVUFBVSxDQUFDLFlBQVksQ0FBQyxLQUFLLFNBQVMsRUFBRTs7QUFFMUMsV0FBTyxLQUFLLENBQUM7R0FDZDs7QUFFRCxTQUFPLFFBQVEsQ0FBQyxZQUFZLENBQUMsQ0FBQztDQUMvQjs7QUFFTSxTQUFTLFFBQVEsQ0FBQyxJQUFJLEVBQUU7O0FBRTdCLFNBQU8sZ0JBQUcsWUFBWSxDQUFDLElBQUksRUFBRSxNQUFNLENBQUMsQ0FBQztDQUN0Qzs7QUFFTSxTQUFTLG1CQUFtQixHQUFHOztBQUVwQyxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLG1CQUFtQixFQUFFLENBQUM7QUFDcEQsTUFBTSxNQUFNLEdBQUcsTUFBTSxDQUFDLFNBQVMsRUFBRSxDQUFDO0FBQ2xDLE1BQU0sTUFBTSxHQUFHLE1BQU0sQ0FBQyxhQUFhLEVBQUUsQ0FBQzs7QUFFdEMsTUFBSSxDQUFDLE1BQU0sRUFBRTs7QUFFWCxXQUFPO0dBQ1I7O0FBRUQsTUFBTSxNQUFNLEdBQUcsTUFBTSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsaUJBQWlCLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQzs7QUFFbkUsdUJBQXFCLENBQUMsSUFBSSxDQUFDOztBQUV6QixVQUFNLEVBQUUsTUFBTTtBQUNkLFVBQU0sRUFBRSxNQUFNO0dBQ2YsQ0FBQyxDQUFDO0NBQ0o7O0FBRU0sU0FBUyxvQkFBb0IsR0FBRzs7QUFFckMsTUFBSSxDQUFDLHFCQUFxQixDQUFDLE1BQU0sRUFBRTs7QUFFakMsV0FBTztHQUNSOztBQUVELE1BQU0sVUFBVSxHQUFHLHFCQUFxQixDQUFDLEdBQUcsRUFBRSxDQUFDOztBQUUvQyx5QkFBdUIsQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxDQUFDLEtBQUssRUFBRSxVQUFVLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUM7Q0FDekY7O0FBRU0sU0FBUyx5QkFBeUIsQ0FBQyxNQUFNLEVBQUUsTUFBTSxFQUFFOztBQUV4RCxNQUFNLEtBQUssR0FBRyxNQUFNLENBQUMseUJBQXlCLEVBQUUsQ0FBQztBQUNqRCxNQUFNLE1BQU0sR0FBRyxNQUFNLENBQUMsZUFBZSxDQUFDLEtBQUssRUFBRSxFQUFDLFVBQVUsRUFBRSxPQUFPLEVBQUMsQ0FBQyxDQUFDOztBQUVwRSxNQUFNLFVBQVUsR0FBRyxNQUFNLENBQUMsY0FBYyxDQUFDLE1BQU0sRUFBRTs7QUFFL0MsUUFBSSxFQUFFLFdBQVc7QUFDakIsYUFBTywrQkFBK0I7QUFDdEMsY0FBVSxFQUFFLE9BQU87R0FDcEIsQ0FBQyxDQUFDOztBQUVILE1BQUksQ0FBQyxVQUFVLEVBQUU7O0FBRWYsV0FBTztHQUNSOztBQUVELFlBQVUsQ0FBQyxZQUFNOztBQUVmLGNBQVUsQ0FBQyxhQUFhLENBQUM7O0FBRXZCLFVBQUksRUFBRSxXQUFXO0FBQ2pCLGVBQU8sc0NBQXNDO0FBQzdDLGdCQUFVLEVBQUUsT0FBTztLQUNwQixDQUFDLENBQUM7R0FFSixFQUFFLENBQUMsQ0FBQyxDQUFDOztBQUVOLFlBQVUsQ0FBQyxZQUFNOztBQUVmLGNBQVUsQ0FBQyxhQUFhLENBQUM7O0FBRXZCLFVBQUksRUFBRSxXQUFXO0FBQ2pCLGVBQU8sK0JBQStCO0FBQ3RDLGdCQUFVLEVBQUUsT0FBTztLQUNwQixDQUFDLENBQUM7R0FFSixFQUFFLElBQUksQ0FBQyxDQUFDOztBQUVULFlBQVUsQ0FBQyxZQUFNOztBQUVmLFVBQU0sQ0FBQyxPQUFPLEVBQUUsQ0FBQztHQUVsQixFQUFFLElBQUksQ0FBQyxDQUFDO0NBQ1YiLCJmaWxlIjoiL1VzZXJzL2xhcnNncmF1Ym5lci8uZG90ZmlsZXMvZG90ZmlsZXMvLmF0b20vcGFja2FnZXMvYXRvbS10ZXJuanMvbGliL2F0b20tdGVybmpzLWhlbHBlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2UgYmFiZWwnO1xuXG5pbXBvcnQgbWFuYWdlciBmcm9tICcuL2F0b20tdGVybmpzLW1hbmFnZXInO1xuaW1wb3J0IHBhY2thZ2VDb25maWcgZnJvbSAnLi9hdG9tLXRlcm5qcy1wYWNrYWdlLWNvbmZpZyc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBmcyBmcm9tICdmcyc7XG5cbmxldCBjaGVja3BvaW50c0RlZmluaXRpb24gPSBbXTtcblxuY29uc3QgdGFncyA9IHtcblxuICAnJic6ICcmYW1wOycsXG4gICc8JzogJyZsdDsnLFxuICAnPic6ICcmZ3Q7J1xufTtcblxuZXhwb3J0IGNvbnN0IGFjY2Vzc0tleSA9ICdhbHRLZXknO1xuXG5leHBvcnQgZnVuY3Rpb24gZm9jdXNFZGl0b3IoKSB7XG5cbiAgY29uc3QgZWRpdG9yID0gYXRvbS53b3Jrc3BhY2UuZ2V0QWN0aXZlVGV4dEVkaXRvcigpO1xuXG4gIGlmICghZWRpdG9yKSB7XG5cbiAgICByZXR1cm47XG4gIH1cblxuICBjb25zdCB2aWV3ID0gYXRvbS52aWV3cy5nZXRWaWV3KGVkaXRvcik7XG5cbiAgdmlldyAmJiB2aWV3LmZvY3VzICYmIHZpZXcuZm9jdXMoKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJlcGxhY2VUYWcodGFnKSB7XG5cbiAgcmV0dXJuIHRhZ3NbdGFnXTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJlcGxhY2VUYWdzKHN0cikge1xuXG4gIGlmICghc3RyKSB7XG5cbiAgICByZXR1cm4gJyc7XG4gIH1cblxuICByZXR1cm4gc3RyLnJlcGxhY2UoL1smPD5dL2csIHJlcGxhY2VUYWcpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZm9ybWF0VHlwZShkYXRhKSB7XG5cbiAgaWYgKCFkYXRhLnR5cGUpIHtcblxuICAgIHJldHVybiAnJztcbiAgfVxuXG4gIGRhdGEudHlwZSA9IGRhdGEudHlwZS5yZXBsYWNlKC8tPi9nLCAnOicpLnJlcGxhY2UoJzx0b3A+JywgJ3dpbmRvdycpO1xuXG4gIGlmICghZGF0YS5leHByTmFtZSkge1xuXG4gICAgcmV0dXJuIGRhdGEudHlwZTtcbiAgfVxuXG4gIGRhdGEudHlwZSA9IGRhdGEudHlwZS5yZXBsYWNlKC9eZm4vLCBkYXRhLmV4cHJOYW1lKTtcblxuICByZXR1cm4gZGF0YS50eXBlO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcHJlcGFyZVR5cGUoZGF0YSkge1xuXG4gIGlmICghZGF0YS50eXBlKSB7XG5cbiAgICByZXR1cm47XG4gIH1cblxuICByZXR1cm4gZGF0YS50eXBlLnJlcGxhY2UoLy0+L2csICc6JykucmVwbGFjZSgnPHRvcD4nLCAnd2luZG93Jyk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwcmVwYXJlSW5saW5lRG9jcyhkYXRhKSB7XG5cbiAgcmV0dXJuIGRhdGFcbiAgICAucmVwbGFjZSgvQHBhcmFtLywgJzxzcGFuIGNsYXNzPVwiZG9jLXBhcmFtLWZpcnN0XCI+QHBhcmFtPC9zcGFuPicpXG4gICAgLnJlcGxhY2UoL0BwYXJhbS9nLCAnPHNwYW4gY2xhc3M9XCJzdG9yYWdlIHR5cGUgZG9jLXBhcmFtXCI+QHBhcmFtPC9zcGFuPicpXG4gICAgLnJlcGxhY2UoL0ByZXR1cm4vLCAnPHNwYW4gY2xhc3M9XCJzdG9yYWdlIHR5cGUgZG9jLXJldHVyblwiPkByZXR1cm48L3NwYW4+JylcbiAgICA7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBidWlsZERpc3BsYXlUZXh0KHBhcmFtcywgbmFtZSkge1xuXG4gIGlmIChwYXJhbXMubGVuZ3RoID09PSAwKSB7XG5cbiAgICByZXR1cm4gYCR7bmFtZX0oKWA7XG4gIH1cblxuICBsZXQgc3VnZ2VzdGlvblBhcmFtcyA9IHBhcmFtcy5tYXAoKHBhcmFtKSA9PiB7XG5cbiAgICBwYXJhbSA9IHBhcmFtLnJlcGxhY2UoJ30nLCAnXFxcXH0nKTtcbiAgICBwYXJhbSA9IHBhcmFtLnJlcGxhY2UoLydcIi9nLCAnJyk7XG5cbiAgICByZXR1cm4gcGFyYW07XG4gIH0pO1xuXG4gIHJldHVybiBgJHtuYW1lfSgke3N1Z2dlc3Rpb25QYXJhbXMuam9pbignLCcpfSlgO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gYnVpbGRTbmlwcGV0KHBhcmFtcywgbmFtZSkge1xuXG4gIGlmIChwYXJhbXMubGVuZ3RoID09PSAwKSB7XG5cbiAgICByZXR1cm4gYCR7bmFtZX0oKWA7XG4gIH1cblxuICBsZXQgc3VnZ2VzdGlvblBhcmFtcyA9IHBhcmFtcy5tYXAoKHBhcmFtLCBpKSA9PiB7XG5cbiAgICBwYXJhbSA9IHBhcmFtLnJlcGxhY2UoJ30nLCAnXFxcXH0nKTtcblxuICAgIHJldHVybiBgXFwkeyR7aSArIDF9OiR7cGFyYW19fWA7XG4gIH0pO1xuXG4gIHJldHVybiBgJHtuYW1lfSgke3N1Z2dlc3Rpb25QYXJhbXMuam9pbignLCcpfSlgO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZXh0cmFjdFBhcmFtcyh0eXBlKSB7XG5cbiAgaWYgKCF0eXBlKSB7XG5cbiAgICByZXR1cm4gW107XG4gIH1cblxuICBsZXQgc3RhcnQgPSB0eXBlLmluZGV4T2YoJygnKSArIDE7XG4gIGxldCBwYXJhbXMgPSBbXTtcbiAgbGV0IGluc2lkZSA9IDA7XG5cbiAgZm9yIChsZXQgaSA9IHN0YXJ0OyBpIDwgdHlwZS5sZW5ndGg7IGkrKykge1xuXG4gICAgaWYgKHR5cGVbaV0gPT09ICc6JyAmJiBpbnNpZGUgPT09IC0xKSB7XG5cbiAgICAgIHBhcmFtcy5wdXNoKHR5cGUuc3Vic3RyaW5nKHN0YXJ0LCBpIC0gMikpO1xuXG4gICAgICBicmVhaztcbiAgICB9XG5cbiAgICBpZiAoaSA9PT0gdHlwZS5sZW5ndGggLSAxKSB7XG5cbiAgICAgIGNvbnN0IHBhcmFtID0gdHlwZS5zdWJzdHJpbmcoc3RhcnQsIGkpO1xuXG4gICAgICBpZiAocGFyYW0ubGVuZ3RoKSB7XG5cbiAgICAgICAgcGFyYW1zLnB1c2gocGFyYW0pO1xuICAgICAgfVxuXG4gICAgICBicmVhaztcbiAgICB9XG5cbiAgICBpZiAodHlwZVtpXSA9PT0gJywnICYmIGluc2lkZSA9PT0gMCkge1xuXG4gICAgICBwYXJhbXMucHVzaCh0eXBlLnN1YnN0cmluZyhzdGFydCwgaSkpO1xuICAgICAgc3RhcnQgPSBpICsgMTtcblxuICAgICAgY29udGludWU7XG4gICAgfVxuXG4gICAgaWYgKHR5cGVbaV0ubWF0Y2goL1t7XFxbXFwoXS8pKSB7XG5cbiAgICAgIGluc2lkZSsrO1xuXG4gICAgICBjb250aW51ZTtcbiAgICB9XG5cbiAgICBpZiAodHlwZVtpXS5tYXRjaCgvW31cXF1cXCldLykpIHtcblxuICAgICAgaW5zaWRlLS07XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHBhcmFtcztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGZvcm1hdFR5cGVDb21wbGV0aW9uKG9iaiwgaXNQcm9wZXJ0eSwgaXNPYmplY3RLZXksIGlzSW5GdW5EZWYpIHtcblxuICBpZiAob2JqLmlzS2V5d29yZCkge1xuXG4gICAgb2JqLl90eXBlU2VsZiA9ICdrZXl3b3JkJztcbiAgfVxuXG4gIGlmIChvYmoudHlwZSA9PT0gJ3N0cmluZycpIHtcblxuICAgIG9iai5uYW1lID0gb2JqLm5hbWUgPyBvYmoubmFtZS5yZXBsYWNlKC8oXlwifFwiJCkvZywgJycpIDogbnVsbDtcblxuICB9IGVsc2Uge1xuXG4gICAgb2JqLm5hbWUgPSBvYmoubmFtZSA/IG9iai5uYW1lLnJlcGxhY2UoL1tcIiddL2csICcnKSA6IG51bGw7XG4gICAgb2JqLm5hbWUgPSBvYmoubmFtZSA/IG9iai5uYW1lLnJlcGxhY2UoL14uLlxcLy8sICcnKSA6IG51bGw7XG4gIH1cblxuICBpZiAoIW9iai50eXBlKSB7XG5cbiAgICBvYmouX2Rpc3BsYXlUZXh0ID0gb2JqLm5hbWU7XG4gICAgb2JqLl9zbmlwcGV0ID0gb2JqLm5hbWU7XG5cbiAgICByZXR1cm4gb2JqO1xuICB9XG5cbiAgaWYgKCFvYmoudHlwZS5zdGFydHNXaXRoKCdmbicpKSB7XG5cbiAgICBpZiAoaXNQcm9wZXJ0eSkge1xuXG4gICAgICBvYmouX3R5cGVTZWxmID0gJ3Byb3BlcnR5JztcblxuICAgIH0gZWxzZSB7XG5cbiAgICAgIG9iai5fdHlwZVNlbGYgPSAndmFyaWFibGUnO1xuICAgIH1cbiAgfVxuXG4gIG9iai50eXBlID0gb2JqLnJpZ2h0TGFiZWwgPSBwcmVwYXJlVHlwZShvYmopO1xuXG4gIGlmIChvYmoudHlwZS5yZXBsYWNlKC9mblxcKC4rXFwpLywgJycpLmxlbmd0aCA9PT0gMCkge1xuXG4gICAgb2JqLmxlZnRMYWJlbCA9ICcnO1xuXG4gIH0gZWxzZSB7XG5cbiAgICBpZiAob2JqLnR5cGUuaW5kZXhPZignZm4nKSA9PT0gLTEpIHtcblxuICAgICAgb2JqLmxlZnRMYWJlbCA9IG9iai50eXBlO1xuXG4gICAgfSBlbHNlIHtcblxuICAgICAgb2JqLmxlZnRMYWJlbCA9IG9iai50eXBlLnJlcGxhY2UoL2ZuXFwoLnswLH1cXCkvLCAnJykucmVwbGFjZSgnIDogJywgJycpO1xuICAgIH1cbiAgfVxuXG4gIGlmIChvYmoucmlnaHRMYWJlbC5zdGFydHNXaXRoKCdmbicpKSB7XG5cbiAgICBsZXQgcGFyYW1zID0gZXh0cmFjdFBhcmFtcyhvYmoucmlnaHRMYWJlbCk7XG5cbiAgICBpZiAoXG4gICAgICBwYWNrYWdlQ29uZmlnLm9wdGlvbnMudXNlU25pcHBldHMgfHxcbiAgICAgIHBhY2thZ2VDb25maWcub3B0aW9ucy51c2VTbmlwcGV0c0FuZEZ1bmN0aW9uXG4gICAgKSB7XG5cbiAgICAgIGlmICghaXNJbkZ1bkRlZikge1xuXG4gICAgICAgIG9iai5fc25pcHBldCA9IGJ1aWxkU25pcHBldChwYXJhbXMsIG9iai5uYW1lKTtcbiAgICAgIH1cblxuICAgICAgb2JqLl9oYXNQYXJhbXMgPSBwYXJhbXMubGVuZ3RoID8gdHJ1ZSA6IGZhbHNlO1xuXG4gICAgfSBlbHNlIHtcblxuICAgICAgaWYgKCFpc0luRnVuRGVmKSB7XG5cbiAgICAgICAgb2JqLl9zbmlwcGV0ID0gcGFyYW1zLmxlbmd0aCA/IGAke29iai5uYW1lfShcXCR7JHswfTpcXCR7fX0pYCA6IGAke29iai5uYW1lfSgpYDtcbiAgICAgIH1cblxuICAgICAgb2JqLl9kaXNwbGF5VGV4dCA9IGJ1aWxkRGlzcGxheVRleHQocGFyYW1zLCBvYmoubmFtZSk7XG4gICAgfVxuXG4gICAgb2JqLl90eXBlU2VsZiA9ICdmdW5jdGlvbic7XG4gIH1cblxuICBpZiAob2JqLm5hbWUpIHtcblxuICAgIGlmIChvYmoubGVmdExhYmVsID09PSBvYmoubmFtZSkge1xuXG4gICAgICBvYmoubGVmdExhYmVsID0gbnVsbDtcbiAgICAgIG9iai5yaWdodExhYmVsID0gbnVsbDtcbiAgICB9XG4gIH1cblxuICBpZiAob2JqLmxlZnRMYWJlbCA9PT0gb2JqLnJpZ2h0TGFiZWwpIHtcblxuICAgIG9iai5yaWdodExhYmVsID0gbnVsbDtcbiAgfVxuXG4gIHJldHVybiBvYmo7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBkaXNwb3NlQWxsKGRpc3Bvc2FibGVzKSB7XG5cbiAgZm9yIChjb25zdCBkaXNwb3NhYmxlIG9mIGRpc3Bvc2FibGVzKSB7XG5cbiAgICBpZiAoIWRpc3Bvc2FibGUpIHtcblxuICAgICAgY29udGludWU7XG4gICAgfVxuXG4gICAgZGlzcG9zYWJsZS5kaXNwb3NlKCk7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG9wZW5GaWxlQW5kR29Ub1Bvc2l0aW9uKHBvc2l0aW9uLCBmaWxlKSB7XG5cbiAgYXRvbS53b3Jrc3BhY2Uub3BlbihmaWxlKS50aGVuKCh0ZXh0RWRpdG9yKSA9PiB7XG5cbiAgICBjb25zdCBjdXJzb3IgPSB0ZXh0RWRpdG9yLmdldExhc3RDdXJzb3IoKTtcblxuICAgIGlmICghY3Vyc29yKSB7XG5cbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjdXJzb3Iuc2V0QnVmZmVyUG9zaXRpb24ocG9zaXRpb24pO1xuICB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG9wZW5GaWxlQW5kR29UbyhzdGFydCwgZmlsZSkge1xuXG4gIGF0b20ud29ya3NwYWNlLm9wZW4oZmlsZSkudGhlbigodGV4dEVkaXRvcikgPT4ge1xuXG4gICAgY29uc3QgYnVmZmVyID0gdGV4dEVkaXRvci5nZXRCdWZmZXIoKTtcbiAgICBjb25zdCBjdXJzb3IgPSB0ZXh0RWRpdG9yLmdldExhc3RDdXJzb3IoKTtcblxuICAgIGlmIChcbiAgICAgICFidWZmZXIgfHxcbiAgICAgICFjdXJzb3JcbiAgICApIHtcblxuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGN1cnNvci5zZXRCdWZmZXJQb3NpdGlvbihidWZmZXIucG9zaXRpb25Gb3JDaGFyYWN0ZXJJbmRleChzdGFydCkpO1xuICAgIG1hcmtEZWZpbml0aW9uQnVmZmVyUmFuZ2UoY3Vyc29yLCB0ZXh0RWRpdG9yKTtcbiAgfSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB1cGRhdGVUZXJuRmlsZShjb250ZW50LCByZXN0YXJ0U2VydmVyKSB7XG5cbiAgY29uc3QgcHJvamVjdFJvb3QgPSBtYW5hZ2VyLnNlcnZlciAmJiBtYW5hZ2VyLnNlcnZlci5wcm9qZWN0RGlyO1xuXG4gIGlmICghcHJvamVjdFJvb3QpIHtcblxuICAgIHJldHVybjtcbiAgfVxuXG4gIHdyaXRlRmlsZShwYXRoLnJlc29sdmUoX19kaXJuYW1lLCBwcm9qZWN0Um9vdCArICcvLnRlcm4tcHJvamVjdCcpLCBjb250ZW50LCByZXN0YXJ0U2VydmVyKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHdyaXRlRmlsZShmaWxlUGF0aCwgY29udGVudCwgcmVzdGFydFNlcnZlcikge1xuXG4gIGZzLndyaXRlRmlsZShmaWxlUGF0aCwgY29udGVudCwgKGVycm9yKSA9PiB7XG5cbiAgICBhdG9tLndvcmtzcGFjZS5vcGVuKGZpbGVQYXRoKTtcblxuICAgIGlmICghZXJyb3IgJiYgcmVzdGFydFNlcnZlcikge1xuXG4gICAgICBtYW5hZ2VyLnJlc3RhcnRTZXJ2ZXIoKTtcbiAgICB9XG5cbiAgICBpZiAoIWVycm9yKSB7XG5cbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBtZXNzYWdlID0gJ0NvdWxkIG5vdCBjcmVhdGUvdXBkYXRlIC50ZXJuLXByb2plY3QgZmlsZS4gVXNlIHRoZSBSRUFETUUgdG8gbWFudWFsbHkgY3JlYXRlIGEgLnRlcm4tcHJvamVjdCBmaWxlLic7XG5cbiAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkSW5mbyhtZXNzYWdlLCB7XG5cbiAgICAgIGRpc21pc3NhYmxlOiB0cnVlXG4gICAgfSk7XG4gIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNEaXJlY3RvcnkoZGlyKSB7XG5cbiAgdHJ5IHtcblxuICAgIHJldHVybiBmcy5zdGF0U3luYyhkaXIpLmlzRGlyZWN0b3J5KCk7XG5cbiAgfSBjYXRjaCAoZXJyb3IpIHtcblxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZmlsZUV4aXN0cyhwYXRoKSB7XG5cbiAgdHJ5IHtcblxuICAgIGZzLmFjY2Vzc1N5bmMocGF0aCwgZnMuRl9PSywgKGVycm9yKSA9PiB7XG5cbiAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICAgIH0pO1xuXG4gIH0gY2F0Y2ggKGVycm9yKSB7XG5cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldEZpbGVDb250ZW50KGZpbGVQYXRoLCByb290KSB7XG5cbiAgY29uc3QgX2ZpbGVQYXRoID0gcm9vdCArIGZpbGVQYXRoO1xuICBjb25zdCByZXNvbHZlZFBhdGggPSBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCBfZmlsZVBhdGgpO1xuXG4gIGlmIChmaWxlRXhpc3RzKHJlc29sdmVkUGF0aCkgIT09IHVuZGVmaW5lZCkge1xuXG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgcmV0dXJuIHJlYWRGaWxlKHJlc29sdmVkUGF0aCk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiByZWFkRmlsZShwYXRoKSB7XG5cbiAgcmV0dXJuIGZzLnJlYWRGaWxlU3luYyhwYXRoLCAndXRmOCcpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc2V0TWFya2VyQ2hlY2twb2ludCgpIHtcblxuICBjb25zdCBlZGl0b3IgPSBhdG9tLndvcmtzcGFjZS5nZXRBY3RpdmVUZXh0RWRpdG9yKCk7XG4gIGNvbnN0IGJ1ZmZlciA9IGVkaXRvci5nZXRCdWZmZXIoKTtcbiAgY29uc3QgY3Vyc29yID0gZWRpdG9yLmdldExhc3RDdXJzb3IoKTtcblxuICBpZiAoIWN1cnNvcikge1xuXG4gICAgcmV0dXJuO1xuICB9XG5cbiAgY29uc3QgbWFya2VyID0gYnVmZmVyLm1hcmtQb3NpdGlvbihjdXJzb3IuZ2V0QnVmZmVyUG9zaXRpb24oKSwge30pO1xuXG4gIGNoZWNrcG9pbnRzRGVmaW5pdGlvbi5wdXNoKHtcblxuICAgIG1hcmtlcjogbWFya2VyLFxuICAgIGVkaXRvcjogZWRpdG9yXG4gIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gbWFya2VyQ2hlY2twb2ludEJhY2soKSB7XG5cbiAgaWYgKCFjaGVja3BvaW50c0RlZmluaXRpb24ubGVuZ3RoKSB7XG5cbiAgICByZXR1cm47XG4gIH1cblxuICBjb25zdCBjaGVja3BvaW50ID0gY2hlY2twb2ludHNEZWZpbml0aW9uLnBvcCgpO1xuXG4gIG9wZW5GaWxlQW5kR29Ub1Bvc2l0aW9uKGNoZWNrcG9pbnQubWFya2VyLmdldFJhbmdlKCkuc3RhcnQsIGNoZWNrcG9pbnQuZWRpdG9yLmdldFVSSSgpKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG1hcmtEZWZpbml0aW9uQnVmZmVyUmFuZ2UoY3Vyc29yLCBlZGl0b3IpIHtcblxuICBjb25zdCByYW5nZSA9IGN1cnNvci5nZXRDdXJyZW50V29yZEJ1ZmZlclJhbmdlKCk7XG4gIGNvbnN0IG1hcmtlciA9IGVkaXRvci5tYXJrQnVmZmVyUmFuZ2UocmFuZ2UsIHtpbnZhbGlkYXRlOiAndG91Y2gnfSk7XG5cbiAgY29uc3QgZGVjb3JhdGlvbiA9IGVkaXRvci5kZWNvcmF0ZU1hcmtlcihtYXJrZXIsIHtcblxuICAgIHR5cGU6ICdoaWdobGlnaHQnLFxuICAgIGNsYXNzOiAnYXRvbS10ZXJuanMtZGVmaW5pdGlvbi1tYXJrZXInLFxuICAgIGludmFsaWRhdGU6ICd0b3VjaCdcbiAgfSk7XG5cbiAgaWYgKCFkZWNvcmF0aW9uKSB7XG5cbiAgICByZXR1cm47XG4gIH1cblxuICBzZXRUaW1lb3V0KCgpID0+IHtcblxuICAgIGRlY29yYXRpb24uc2V0UHJvcGVydGllcyh7XG5cbiAgICAgIHR5cGU6ICdoaWdobGlnaHQnLFxuICAgICAgY2xhc3M6ICdhdG9tLXRlcm5qcy1kZWZpbml0aW9uLW1hcmtlciBhY3RpdmUnLFxuICAgICAgaW52YWxpZGF0ZTogJ3RvdWNoJ1xuICAgIH0pO1xuXG4gIH0sIDEpO1xuXG4gIHNldFRpbWVvdXQoKCkgPT4ge1xuXG4gICAgZGVjb3JhdGlvbi5zZXRQcm9wZXJ0aWVzKHtcblxuICAgICAgdHlwZTogJ2hpZ2hsaWdodCcsXG4gICAgICBjbGFzczogJ2F0b20tdGVybmpzLWRlZmluaXRpb24tbWFya2VyJyxcbiAgICAgIGludmFsaWRhdGU6ICd0b3VjaCdcbiAgICB9KTtcblxuICB9LCAxNTAxKTtcblxuICBzZXRUaW1lb3V0KCgpID0+IHtcblxuICAgIG1hcmtlci5kZXN0cm95KCk7XG5cbiAgfSwgMjUwMCk7XG59XG4iXX0=