Object.defineProperty(exports, '__esModule', {
	value: true
});

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

/** @babel */

var _commandsGenerate = require('./commands/generate');

var _commandsGenerate2 = _interopRequireDefault(_commandsGenerate);

var _commandsShow = require('./commands/show');

var _commandsShow2 = _interopRequireDefault(_commandsShow);

var _commandsFix = require('./commands/fix');

var _commandsFix2 = _interopRequireDefault(_commandsFix);

var lazyReq = require('lazy-req')(require);

var atm = lazyReq('atom');

var statusTile = lazyReq('./lib/statustile-view');
var wrapGuide = lazyReq('./lib/wrapguide-view');
var editorconfig = lazyReq('editorconfig');

var STATES = ['subtle', 'success', 'info', 'warning', 'error'];

// Holds all **blacklisted** packages and the properties we assume are affected by them
// 'packagename': [properties]
var BLACKLISTED_PACKAGES = {
	whitespace: ['insert_final_newline', 'trim_trailing_whitespace']
};

// Sets the state of the embedded editorconfig
// This includes the severity (info, warning..) as well as the notification-messages for users
function setState(ecfg) {
	var messages = [];
	var statcon = 0;

	// Check if any editorconfig-setting is in use
	if (Object.keys(ecfg.settings).reduce(function (prev, curr) {
		return ecfg.settings[curr] !== 'auto' || prev;
	}, false)) {
		statcon = Math.max(statcon, 1);
	}

	// Check the 'Tab Type'-setting
	if (ecfg.settings.indent_style !== 'auto' && atom.config.get('editor.tabType') !== 'auto') {
		var tabType = atom.config.get('editor.tabType');

		messages.push('**Tab Type:** You editor\'s configuration setting "Tab Type"\n\t\t(currently "' + tabType + '" prevents the editorconfig-property `indent_style` from working.\n\t\t@"Tab Type" **must** be set to "auto" to fix this issue.');

		statcon = Math.max(statcon, 4);
	}

	// Check for BLACKLISTED packages
	var suspiciuousPackages = {};
	var affectedProperties = undefined;
	for (var packageName in BLACKLISTED_PACKAGES) {
		if (({}).hasOwnProperty.call(BLACKLISTED_PACKAGES, packageName)) {
			affectedProperties = BLACKLISTED_PACKAGES[packageName].filter(function (prop) {
				return ecfg.settings[prop] !== 'auto';
			});
			if (affectedProperties.length > 0 && atom.packages.isPackageActive(packageName)) {
				suspiciuousPackages[packageName] = affectedProperties;
			}
		}
	}
	if (Object.keys(suspiciuousPackages).length > 0) {
		for (var packageName in suspiciuousPackages) {
			if (({}).hasOwnProperty.call(suspiciuousPackages, packageName)) {
				var properties = suspiciuousPackages[packageName];
				messages.push('**' + packageName + ':** It is likely that the\n\t\t\t\t' + packageName + '-package prevents the following\n\t\t\t\tpropert' + (properties.length > 1 ? 'ies' : 'y') + ' from working reliably:\n\t\t\t\t`' + properties.join('`, `') + '`.@You may deactivate or disable the ' + packageName + '-package\n\t\t\t\tto fix that issue.');
			}
		}
		statcon = Math.max(statcon, 3);
	}

	switch (statcon) {
		case 1:
			messages.push('The editorconfig was applied successfully and the editor for this file\n\t\t\tshould work as expected. If you face any unexpected behavior please report us the issue.\n\t\t\t♥️');
			break;
		case 0:
			messages.push('For this file were no editorconfig-settings applied.');
			break;
		default:
			break;
	}

	// Apply changes
	ecfg.messages = messages;
	ecfg.state = STATES[statcon];
	statusTile().updateIcon(ecfg.state);
}

// Initializes the (into the TextBuffer-instance) embedded editorconfig-object
function initializeTextBuffer(buffer) {
	if ('editorconfig' in buffer === false) {
		buffer.editorconfig = {
			buffer: buffer, // preserving a reference to the parent TextBuffer
			disposables: new (atm().CompositeDisposable)(),
			state: 'subtle',
			settings: {
				trim_trailing_whitespace: 'auto', // eslint-disable-line camelcase
				insert_final_newline: 'auto', // eslint-disable-line camelcase
				max_line_length: 'auto', // eslint-disable-line camelcase
				end_of_line: 'auto', // eslint-disable-line camelcase
				indent_style: 'auto', // eslint-disable-line camelcase
				tab_width: 'auto', // eslint-disable-line camelcase
				charset: 'auto' // eslint-disable-line camelcase
			},

			// Sets the given package active or inactive
			setPackageState: function setPackageState(name, active) {
				if (atom.packages.isPackageDisabled(name) === false && atom.packages.isPackageActive(name) !== active) {
					if (active === true) {
						atom.packages.activatePackage(name);
					} else {
						atom.packages.deactivatePackage(name);
					}
				}
			},

			// Applies the settings to the buffer and the corresponding editor
			applySettings: function applySettings() {
				var editor = atom.workspace.getTextEditors().reduce(function (prev, curr) {
					return curr.getBuffer() === buffer && curr || prev;
				}, undefined);
				if (!editor) {
					return;
				}

				var configOptions = { scope: editor.getRootScopeDescriptor() };
				var settings = this.settings;

				if (editor && editor.getBuffer() === buffer) {
					if (settings.indent_style === 'auto') {
						editor.setSoftTabs(atom.config.get('editor.softTabs', configOptions));
					} else {
						editor.setSoftTabs(settings.indent_style === 'space');
					}

					if (settings.tab_width === 'auto') {
						editor.setTabLength(atom.config.get('editor.tabLength', configOptions));
					} else {
						editor.setTabLength(settings.tab_width);
					}

					if (settings.charset === 'auto') {
						buffer.setEncoding(atom.config.get('core.fileEncoding', configOptions));
					} else {
						buffer.setEncoding(settings.charset);
					}

					// max_line_length-settings
					var editorParams = {};
					if (settings.max_line_length === 'auto') {
						editorParams.softWrapped = atom.config.get('editor.softWrap', configOptions);
						editorParams.softWrapAtPreferredLineLength = atom.config.get('editor.softWrapAtPreferredLineLength', configOptions);
						editorParams.preferredLineLength = atom.config.get('editor.preferredLineLength', configOptions);
					} else {
						editorParams.softWrapped = true;
						editorParams.softWrapAtPreferredLineLength = true;
						editorParams.preferredLineLength = settings.max_line_length;
					}

					// Update the editor-properties
					editor.update(editorParams);

					// Ensure the wrap-guide is set properly
					if (this.wrapGuide === undefined) {
						this.wrapGuide = new (wrapGuide())();
						this.wrapGuide.initialize(editor, atom.views.getView(editor));
					}
					this.wrapGuide.update();
					// Toggle the wrap-guide package if necessary
					this.setPackageState('wrap-guide', this.wrapGuide.isVisible() === false);

					if (settings.end_of_line !== 'auto') {
						buffer.setPreferredLineEnding(settings.end_of_line);
					}
				}
				setState(this);
			},

			// onWillSave-Event-Handler
			// Trims whitespaces and inserts/strips final newline before saving
			onWillSave: function onWillSave() {
				var settings = this.settings;

				if (settings.trim_trailing_whitespace === true) {
					// eslint-disable-next-line max-params
					buffer.backwardsScan(/[ \t]+$/gm, function (params) {
						if (params.match[0].length > 0) {
							params.replace('');
						}
					});
				}

				if (settings.insert_final_newline !== 'auto') {
					var lastRow = buffer.getLineCount() - 1;

					if (buffer.isRowBlank(lastRow)) {
						var stripStart = buffer.previousNonBlankRow(lastRow);

						if (settings.insert_final_newline === true) {
							stripStart += 1;
						}
						// Strip empty lines from the end
						if (stripStart < lastRow) {
							buffer.deleteRows(stripStart + 1, lastRow);
						}
					} else if (settings.insert_final_newline === true) {
						buffer.append('\n');
					}
				}
			}
		};

		buffer.editorconfig.disposables.add(buffer.onWillSave(buffer.editorconfig.onWillSave.bind(buffer.editorconfig)));
		if (buffer.getUri() && buffer.getUri().match(/[\\|/]\.editorconfig$/g) !== null) {
			buffer.editorconfig.disposables.add(buffer.onDidSave(reapplyEditorconfig));
		}
	}
}

// Reveal and apply the editorconfig for the given TextEditor-instance
function observeTextEditor(editor) {
	if (!editor) {
		return;
	}
	initializeTextBuffer(editor.getBuffer());

	var file = editor.getURI();
	if (!file) {
		editor.onDidSave(function () {
			observeTextEditor(editor);
		});
		return;
	}

	editorconfig().parse(file).then(function (config) {
		if (Object.keys(config).length === 0) {
			return;
		}

		var ecfg = editor.getBuffer().editorconfig;
		var settings = ecfg.settings;
		var lineEndings = {
			crlf: '\r\n',
			cr: '\r',
			lf: '\n'
		};

		// Preserve evaluated Editorconfig
		ecfg.config = config;

		// Carefully normalize and initialize config-settings
		// eslint-disable-next-line camelcase
		settings.trim_trailing_whitespace = 'trim_trailing_whitespace' in config && typeof config.trim_trailing_whitespace === 'boolean' ? config.trim_trailing_whitespace === true : 'auto';

		// eslint-disable-next-line camelcase
		settings.insert_final_newline = 'insert_final_newline' in config && typeof config.insert_final_newline === 'boolean' ? config.insert_final_newline === true : 'auto';

		// eslint-disable-next-line camelcase
		settings.indent_style = 'indent_style' in config && config.indent_style.search(/^(space|tab)$/) > -1 ? config.indent_style : 'auto';

		// eslint-disable-next-line camelcase
		settings.end_of_line = lineEndings[config.end_of_line] || 'auto';

		// eslint-disable-next-line camelcase
		settings.tab_width = parseInt(config.indent_size || config.tab_width, 10);
		if (isNaN(settings.tab_width) || settings.tab_width <= 0) {
			settings.tab_width = 'auto'; // eslint-disable-line camelcase
		}

		// eslint-disable-next-line camelcase
		settings.max_line_length = parseInt(config.max_line_length, 10);
		if (isNaN(settings.max_line_length) || settings.max_line_length <= 0) {
			settings.max_line_length = 'auto'; // eslint-disable-line camelcase
		}

		settings.charset = 'charset' in config ? config.charset.replace(/-/g, '').toLowerCase() : 'auto';

		ecfg.applySettings();
	})['catch'](Error, function (e) {
		console.warn('atom-editorconfig: ' + e);
	});
}

// Reapplies the whole editorconfig to **all** open TextEditor-instances
function reapplyEditorconfig() {
	var textEditors = atom.workspace.getTextEditors();
	textEditors.forEach(function (editor) {
		observeTextEditor(editor);
	});
}

// Reapplies the settings immediately after changing the focus to a new pane
function observeActivePaneItem(editor) {
	if (editor && editor.constructor.name === 'TextEditor') {
		if (editor.getBuffer().editorconfig) {
			editor.getBuffer().editorconfig.applySettings();
		}
	} else {
		statusTile().removeIcon();
	}
}

// Hook into the events to recognize the user opening new editors or changing the pane
var activate = function activate() {
	(0, _commandsGenerate2['default'])();
	(0, _commandsShow2['default'])();
	(0, _commandsFix2['default'])();
	atom.workspace.observeTextEditors(observeTextEditor);
	atom.workspace.observeActivePaneItem(observeActivePaneItem);
};

// Clean the status-icon up, remove all embedded editorconfig-objects
var deactivate = function deactivate() {
	var textEditors = atom.workspace.getTextEditors();
	textEditors.forEach(function (editor) {
		editor.getBuffer().editorconfig.disposables.dispose();
	});
	statusTile().removeIcon();
};

// Apply the statusbar icon-container
// The icon will be applied if needed
var consumeStatusBar = function consumeStatusBar(statusBar) {
	if (statusTile().containerExists() === false) {
		statusBar.addRightTile({
			item: statusTile().createContainer(),
			priority: 999
		});
	}
};

exports['default'] = { activate: activate, deactivate: deactivate, consumeStatusBar: consumeStatusBar };
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9sYXJzZ3JhdWJuZXIvLmRvdGZpbGVzL2RvdGZpbGVzLy5hdG9tL3BhY2thZ2VzL2VkaXRvcmNvbmZpZy9pbmRleC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7OztnQ0FDMkIscUJBQXFCOzs7OzRCQUMxQixpQkFBaUI7Ozs7MkJBQ25CLGdCQUFnQjs7OztBQUVwQyxJQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUM7O0FBRTdDLElBQU0sR0FBRyxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQzs7QUFFNUIsSUFBTSxVQUFVLEdBQUcsT0FBTyxDQUFDLHVCQUF1QixDQUFDLENBQUM7QUFDcEQsSUFBTSxTQUFTLEdBQUcsT0FBTyxDQUFDLHNCQUFzQixDQUFDLENBQUM7QUFDbEQsSUFBTSxZQUFZLEdBQUcsT0FBTyxDQUFDLGNBQWMsQ0FBQyxDQUFDOztBQUU3QyxJQUFNLE1BQU0sR0FBRyxDQUFDLFFBQVEsRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxPQUFPLENBQUMsQ0FBQzs7OztBQUlqRSxJQUFNLG9CQUFvQixHQUFHO0FBQzVCLFdBQVUsRUFBRSxDQUFDLHNCQUFzQixFQUFFLDBCQUEwQixDQUFDO0NBQ2hFLENBQUM7Ozs7QUFJRixTQUFTLFFBQVEsQ0FBQyxJQUFJLEVBQUU7QUFDdkIsS0FBTSxRQUFRLEdBQUcsRUFBRSxDQUFDO0FBQ3BCLEtBQUksT0FBTyxHQUFHLENBQUMsQ0FBQzs7O0FBR2hCLEtBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsTUFBTSxDQUFDLFVBQUMsSUFBSSxFQUFFLElBQUksRUFBSztBQUNyRCxTQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEtBQUssTUFBTSxJQUFJLElBQUksQ0FBQztFQUM5QyxFQUFFLEtBQUssQ0FBQyxFQUFFO0FBQ1YsU0FBTyxHQUFHLElBQUks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O0FBQ0gsV0FBVSxFQUFFLENBQUMsVUFBVSxFQUFFLENBQUM7Q0FDMUIsQ0FBQzs7OztBQUlGLElBQU0sZ0JBQWdCLEdBQUcsU0FBbkIsZ0JBQWdCLENBQUcsU0FBUyxFQUFJO0FBQ3JDLEtBQUksVUFBVSxFQUFFLENBQUMsZUFBZSxFQUFFLEtBQUssS0FBSyxFQUFFO0FBQzdDLFdBQVMsQ0FBQyxZQUFZLENBQUM7QUFDdEIsT0FBSSxFQUFFLFVBQVUsRUFBRSxDQUFDLGVBQWUsRUFBRTtBQUNwQyxXQUFRLEVBQUUsR0FBRztHQUNiLENBQUMsQ0FBQztFQUNIO0NBQ0QsQ0FBQzs7cUJBRWEsRUFBQyxRQUFRLEVBQVIsUUFBUSxFQUFFLFVBQVUsRUFBVixVQUFVLEVBQUUsZ0JBQWdCLEVBQWhCLGdCQUFnQixFQUFDIiwiZmlsZSI6Ii9Vc2Vycy9sYXJzZ3JhdWJuZXIvLmRvdGZpbGVzL2RvdGZpbGVzLy5hdG9tL3BhY2thZ2VzL2VkaXRvcmNvbmZpZy9pbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKiBAYmFiZWwgKi9cbmltcG9ydCBnZW5lcmF0ZUNvbmZpZyBmcm9tICcuL2NvbW1hbmRzL2dlbmVyYXRlJztcbmltcG9ydCBzaG93U3RhdGUgZnJvbSAnLi9jb21tYW5kcy9zaG93JztcbmltcG9ydCBmaXhGaWxlIGZyb20gJy4vY29tbWFuZHMvZml4JztcblxuY29uc3QgbGF6eVJlcSA9IHJlcXVpcmUoJ2xhenktcmVxJykocmVxdWlyZSk7XG5cbmNvbnN0IGF0bSA9IGxhenlSZXEoJ2F0b20nKTtcblxuY29uc3Qgc3RhdHVzVGlsZSA9IGxhenlSZXEoJy4vbGliL3N0YXR1c3RpbGUtdmlldycpO1xuY29uc3Qgd3JhcEd1aWRlID0gbGF6eVJlcSgnLi9saWIvd3JhcGd1aWRlLXZpZXcnKTtcbmNvbnN0IGVkaXRvcmNvbmZpZyA9IGxhenlSZXEoJ2VkaXRvcmNvbmZpZycpO1xuXG5jb25zdCBTVEFURVMgPSBbJ3N1YnRsZScsICdzdWNjZXNzJywgJ2luZm8nLCAnd2FybmluZycsICdlcnJvciddO1xuXG4vLyBIb2xkcyBhbGwgKipibGFja2xpc3RlZCoqIHBhY2thZ2VzIGFuZCB0aGUgcHJvcGVydGllcyB3ZSBhc3N1bWUgYXJlIGFmZmVjdGVkIGJ5IHRoZW1cbi8vICdwYWNrYWdlbmFtZSc6IFtwcm9wZXJ0aWVzXVxuY29uc3QgQkxBQ0tMSVNURURfUEFDS0FHRVMgPSB7XG5cdHdoaXRlc3BhY2U6IFsnaW5zZXJ0X2ZpbmFsX25ld2xpbmUnLCAndHJpbV90cmFpbGluZ193aGl0ZXNwYWNlJ11cbn07XG5cbi8vIFNldHMgdGhlIHN0YXRlIG9mIHRoZSBlbWJlZGRlZCBlZGl0b3Jjb25maWdcbi8vIFRoaXMgaW5jbHVkZXMgdGhlIHNldmVyaXR5IChpbmZvLCB3YXJuaW5nLi4pIGFzIHdlbGwgYXMgdGhlIG5vdGlmaWNhdGlvbi1tZXNzYWdlcyBmb3IgdXNlcnNcbmZ1bmN0aW9uIHNldFN0YXRlKGVjZmcpIHtcblx0Y29uc3QgbWVzc2FnZXMgPSBbXTtcblx0bGV0IHN0YXRjb24gPSAwO1xuXG5cdC8vIENoZWNrIGlmIGFueSBlZGl0b3Jjb25maWctc2V0dGluZyBpcyBpbiB1c2Vcblx0aWYgKE9iamVjdC5rZXlzKGVjZmcuc2V0dGluZ3MpLnJlZHVjZSgocHJldiwgY3VycikgPT4ge1xuXHRcdHJldHVybiBlY2ZnLnNldHRpbmdzW2N1cnJdICE9PSAnYXV0bycgfHwgcHJldjtcblx0fSwgZmFsc2UpKSB7XG5cdFx0c3RhdGNvbiA9IE1hdGgubWF4KHN0YXRjb24sIDEpO1xuXHR9XG5cblx0Ly8gQ2hlY2sgdGhlICdUYWIgVHlwZSctc2V0dGluZ1xuXHRpZiAoZWNmZy5zZXR0aW5ncy5pbmRlbnRfc3R5bGUgIT09ICdhdXRvJyAmJlxuXHRcdGF0b20uY29uZmlnLmdldCgnZWRpdG9yLnRhYlR5cGUnKSAhPT0gJ2F1dG8nKSB7XG5cdFx0Y29uc3QgdGFiVHlwZSA9IGF0b20uY29uZmlnLmdldCgnZWRpdG9yLnRhYlR5cGUnKTtcblxuXHRcdG1lc3NhZ2VzLnB1c2goYCoqVGFiIFR5cGU6KiogWW91IGVkaXRvcidzIGNvbmZpZ3VyYXRpb24gc2V0dGluZyBcIlRhYiBUeXBlXCJcblx0XHQoY3VycmVudGx5IFwiJHt0YWJUeXBlfVwiIHByZXZlbnRzIHRoZSBlZGl0b3Jjb25maWctcHJvcGVydHkgXFxgaW5kZW50X3N0eWxlXFxgIGZyb20gd29ya2luZy5cblx0XHRAXCJUYWIgVHlwZVwiICoqbXVzdCoqIGJlIHNldCB0byBcImF1dG9cIiB0byBmaXggdGhpcyBpc3N1ZS5gKTtcblxuXHRcdHN0YXRjb24gPSBNYXRoLm1heChzdGF0Y29uLCA0KTtcblx0fVxuXG5cdC8vIENoZWNrIGZvciBCTEFDS0xJU1RFRCBwYWNrYWdlc1xuXHRjb25zdCBzdXNwaWNpdW91c1BhY2thZ2VzID0ge307XG5cdGxldCBhZmZlY3RlZFByb3BlcnRpZXM7XG5cdGZvciAoY29uc3QgcGFja2FnZU5hbWUgaW4gQkxBQ0tMSVNURURfUEFDS0FHRVMpIHtcblx0XHRpZiAoe30uaGFzT3duUHJvcGVydHkuY2FsbChCTEFDS0xJU1RFRF9QQUNLQUdFUywgcGFja2FnZU5hbWUpKSB7XG5cdFx0XHRhZmZlY3RlZFByb3BlcnRpZXMgPSBCTEFDS0xJU1RFRF9QQUNLQUdFU1twYWNrYWdlTmFtZV0uZmlsdGVyKHByb3AgPT4ge1xuXHRcdFx0XHRyZXR1cm4gZWNmZy5zZXR0aW5nc1twcm9wXSAhPT0gJ2F1dG8nO1xuXHRcdFx0fSk7XG5cdFx0XHRpZiAoYWZmZWN0ZWRQcm9wZXJ0aWVzLmxlbmd0aCA+IDAgJiZcblx0XHRcdFx0YXRvbS5wYWNrYWdlcy5pc1BhY2thZ2VBY3RpdmUocGFja2FnZU5hbWUpKSB7XG5cdFx0XHRcdHN1c3BpY2l1b3VzUGFja2FnZXNbcGFja2FnZU5hbWVdID0gYWZmZWN0ZWRQcm9wZXJ0aWVzO1xuXHRcdFx0fVxuXHRcdH1cblx0fVxuXHRpZiAoT2JqZWN0LmtleXMoc3VzcGljaXVvdXNQYWNrYWdlcykubGVuZ3RoID4gMCkge1xuXHRcdGZvciAoY29uc3QgcGFja2FnZU5hbWUgaW4gc3VzcGljaXVvdXNQYWNrYWdlcykge1xuXHRcdFx0aWYgKHt9Lmhhc093blByb3BlcnR5LmNhbGwoc3VzcGljaXVvdXNQYWNrYWdlcywgcGFja2FnZU5hbWUpKSB7XG5cdFx0XHRcdGNvbnN0IHByb3BlcnRpZXMgPSBzdXNwaWNpdW91c1BhY2thZ2VzW3BhY2thZ2VOYW1lXTtcblx0XHRcdFx0bWVzc2FnZXMucHVzaChgKioke3BhY2thZ2VOYW1lfToqKiBJdCBpcyBsaWtlbHkgdGhhdCB0aGVcblx0XHRcdFx0JHtwYWNrYWdlTmFtZX0tcGFja2FnZSBwcmV2ZW50cyB0aGUgZm9sbG93aW5nXG5cdFx0XHRcdHByb3BlcnQke3Byb3BlcnRpZXMubGVuZ3RoID4gMSA/ICdpZXMnIDogJ3knfSBmcm9tIHdvcmtpbmcgcmVsaWFibHk6XG5cdFx0XHRcdFxcYCR7cHJvcGVydGllcy5qb2luKCdgLCBgJyl9XFxgLkBZb3UgbWF5IGRlYWN0aXZhdGUgb3IgZGlzYWJsZSB0aGUgJHtwYWNrYWdlTmFtZX0tcGFja2FnZVxuXHRcdFx0XHR0byBmaXggdGhhdCBpc3N1ZS5gKTtcblx0XHRcdH1cblx0XHR9XG5cdFx0c3RhdGNvbiA9IE1hdGgubWF4KHN0YXRjb24sIDMpO1xuXHR9XG5cblx0c3dpdGNoIChzdGF0Y29uKSB7XG5cdFx0Y2FzZSAxOlxuXHRcdFx0bWVzc2FnZXMucHVzaChgVGhlIGVkaXRvcmNvbmZpZyB3YXMgYXBwbGllZCBzdWNjZXNzZnVsbHkgYW5kIHRoZSBlZGl0b3IgZm9yIHRoaXMgZmlsZVxuXHRcdFx0c2hvdWxkIHdvcmsgYXMgZXhwZWN0ZWQuIElmIHlvdSBmYWNlIGFueSB1bmV4cGVjdGVkIGJlaGF2aW9yIHBsZWFzZSByZXBvcnQgdXMgdGhlIGlzc3VlLlxuXHRcdFx04pml77iPYCk7XG5cdFx0XHRicmVhaztcblx0XHRjYXNlIDA6XG5cdFx0XHRtZXNzYWdlcy5wdXNoKGBGb3IgdGhpcyBmaWxlIHdlcmUgbm8gZWRpdG9yY29uZmlnLXNldHRpbmdzIGFwcGxpZWQuYCk7XG5cdFx0XHRicmVhaztcblx0XHRkZWZhdWx0OlxuXHRcdFx0YnJlYWs7XG5cdH1cblxuXHQvLyBBcHBseSBjaGFuZ2VzXG5cdGVjZmcubWVzc2FnZXMgPSBtZXNzYWdlcztcblx0ZWNmZy5zdGF0ZSA9IFNUQVRFU1tzdGF0Y29uXTtcblx0c3RhdHVzVGlsZSgpLnVwZGF0ZUljb24oZWNmZy5zdGF0ZSk7XG59XG5cbi8vIEluaXRpYWxpemVzIHRoZSAoaW50byB0aGUgVGV4dEJ1ZmZlci1pbnN0YW5jZSkgZW1iZWRkZWQgZWRpdG9yY29uZmlnLW9iamVjdFxuZnVuY3Rpb24gaW5pdGlhbGl6ZVRleHRCdWZmZXIoYnVmZmVyKSB7XG5cdGlmICgnZWRpdG9yY29uZmlnJyBpbiBidWZmZXIgPT09IGZhbHNlKSB7XG5cdFx0YnVmZmVyLmVkaXRvcmNvbmZpZyA9IHtcblx0XHRcdGJ1ZmZlciwgLy8gcHJlc2VydmluZyBhIHJlZmVyZW5jZSB0byB0aGUgcGFyZW50IFRleHRCdWZmZXJcblx0XHRcdGRpc3Bvc2FibGVzOiBuZXcgKGF0bSgpLkNvbXBvc2l0ZURpc3Bvc2FibGUpKCksXG5cdFx0XHRzdGF0ZTogJ3N1YnRsZScsXG5cdFx0XHRzZXR0aW5nczoge1xuXHRcdFx0XHR0cmltX3RyYWlsaW5nX3doaXRlc3BhY2U6ICdhdXRvJywgLy8gZXNsaW50LWRpc2FibGUtbGluZSBjYW1lbGNhc2Vcblx0XHRcdFx0aW5zZXJ0X2ZpbmFsX25ld2xpbmU6ICdhdXRvJywgLy8gZXNsaW50LWRpc2FibGUtbGluZSBjYW1lbGNhc2Vcblx0XHRcdFx0bWF4X2xpbmVfbGVuZ3RoOiAnYXV0bycsIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgY2FtZWxjYXNlXG5cdFx0XHRcdGVuZF9vZl9saW5lOiAnYXV0bycsIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgY2FtZWxjYXNlXG5cdFx0XHRcdGluZGVudF9zdHlsZTogJ2F1dG8nLCAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIGNhbWVsY2FzZVxuXHRcdFx0XHR0YWJfd2lkdGg6ICdhdXRvJywgLy8gZXNsaW50LWRpc2FibGUtbGluZSBjYW1lbGNhc2Vcblx0XHRcdFx0Y2hhcnNldDogJ2F1dG8nIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgY2FtZWxjYXNlXG5cdFx0XHR9LFxuXG5cdFx0XHQvLyBTZXRzIHRoZSBnaXZlbiBwYWNrYWdlIGFjdGl2ZSBvciBpbmFjdGl2ZVxuXHRcdFx0c2V0UGFja2FnZVN0YXRlKG5hbWUsIGFjdGl2ZSkge1xuXHRcdFx0XHRpZiAoYXRvbS5wYWNrYWdlcy5pc1BhY2thZ2VEaXNhYmxlZChuYW1lKSA9PT0gZmFsc2UgJiZcblx0XHRcdFx0XHRhdG9tLnBhY2thZ2VzLmlzUGFja2FnZUFjdGl2ZShuYW1lKSAhPT0gYWN0aXZlKSB7XG5cdFx0XHRcdFx0aWYgKGFjdGl2ZSA9PT0gdHJ1ZSkge1xuXHRcdFx0XHRcdFx0YXRvbS5wYWNrYWdlcy5hY3RpdmF0ZVBhY2thZ2UobmFtZSk7XG5cdFx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRcdGF0b20ucGFja2FnZXMuZGVhY3RpdmF0ZVBhY2thZ2UobmFtZSk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9XG5cdFx0XHR9LFxuXG5cdFx0XHQvLyBBcHBsaWVzIHRoZSBzZXR0aW5ncyB0byB0aGUgYnVmZmVyIGFuZCB0aGUgY29ycmVzcG9uZGluZyBlZGl0b3Jcblx0XHRcdGFwcGx5U2V0dGluZ3MoKSB7XG5cdFx0XHRcdGNvbnN0IGVkaXRvciA9IGF0b20ud29ya3NwYWNlLmdldFRleHRFZGl0b3JzKCkucmVkdWNlKChwcmV2LCBjdXJyKSA9PiB7XG5cdFx0XHRcdFx0cmV0dXJuIChjdXJyLmdldEJ1ZmZlcigpID09PSBidWZmZXIgJiYgY3VycikgfHwgcHJldjtcblx0XHRcdFx0fSwgdW5kZWZpbmVkKTtcblx0XHRcdFx0aWYgKCFlZGl0b3IpIHtcblx0XHRcdFx0XHRyZXR1cm47XG5cdFx0XHRcdH1cblxuXHRcdFx0XHRjb25zdCBjb25maWdPcHRpb25zID0ge3Njb3BlOiBlZGl0b3IuZ2V0Um9vdFNjb3BlRGVzY3JpcHRvcigpfTtcblx0XHRcdFx0Y29uc3Qgc2V0dGluZ3MgPSB0aGlzLnNldHRpbmdzO1xuXG5cdFx0XHRcdGlmIChlZGl0b3IgJiYgZWRpdG9yLmdldEJ1ZmZlcigpID09PSBidWZmZXIpIHtcblx0XHRcdFx0XHRpZiAoc2V0dGluZ3MuaW5kZW50X3N0eWxlID09PSAnYXV0bycpIHtcblx0XHRcdFx0XHRcdGVkaXRvci5zZXRTb2Z0VGFicyhhdG9tLmNvbmZpZy5nZXQoJ2VkaXRvci5zb2Z0VGFicycsIGNvbmZpZ09wdGlvbnMpKTtcblx0XHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdFx0ZWRpdG9yLnNldFNvZnRUYWJzKHNldHRpbmdzLmluZGVudF9zdHlsZSA9PT0gJ3NwYWNlJyk7XG5cdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0aWYgKHNldHRpbmdzLnRhYl93aWR0aCA9PT0gJ2F1dG8nKSB7XG5cdFx0XHRcdFx0XHRlZGl0b3Iuc2V0VGFiTGVuZ3RoKGF0b20uY29uZmlnLmdldCgnZWRpdG9yLnRhYkxlbmd0aCcsIGNvbmZpZ09wdGlvbnMpKTtcblx0XHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdFx0ZWRpdG9yLnNldFRhYkxlbmd0aChzZXR0aW5ncy50YWJfd2lkdGgpO1xuXHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdGlmIChzZXR0aW5ncy5jaGFyc2V0ID09PSAnYXV0bycpIHtcblx0XHRcdFx0XHRcdGJ1ZmZlci5zZXRFbmNvZGluZyhhdG9tLmNvbmZpZy5nZXQoJ2NvcmUuZmlsZUVuY29kaW5nJywgY29uZmlnT3B0aW9ucykpO1xuXHRcdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0XHRidWZmZXIuc2V0RW5jb2Rpbmcoc2V0dGluZ3MuY2hhcnNldCk7XG5cdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0Ly8gbWF4X2xpbmVfbGVuZ3RoLXNldHRpbmdzXG5cdFx0XHRcdFx0Y29uc3QgZWRpdG9yUGFyYW1zID0ge307XG5cdFx0XHRcdFx0aWYgKHNldHRpbmdzLm1heF9saW5lX2xlbmd0aCA9PT0gJ2F1dG8nKSB7XG5cdFx0XHRcdFx0XHRlZGl0b3JQYXJhbXMuc29mdFdyYXBwZWQgPSBhdG9tLmNvbmZpZy5nZXQoJ2VkaXRvci5zb2Z0V3JhcCcsIGNvbmZpZ09wdGlvbnMpO1xuXHRcdFx0XHRcdFx0ZWRpdG9yUGFyYW1zLnNvZnRXcmFwQXRQcmVmZXJyZWRMaW5lTGVuZ3RoID1cblx0XHRcdFx0XHRcdFx0YXRvbS5jb25maWcuZ2V0KCdlZGl0b3Iuc29mdFdyYXBBdFByZWZlcnJlZExpbmVMZW5ndGgnLCBjb25maWdPcHRpb25zKTtcblx0XHRcdFx0XHRcdGVkaXRvclBhcmFtcy5wcmVmZXJyZWRMaW5lTGVuZ3RoID1cblx0XHRcdFx0XHRcdFx0YXRvbS5jb25maWcuZ2V0KCdlZGl0b3IucHJlZmVycmVkTGluZUxlbmd0aCcsIGNvbmZpZ09wdGlvbnMpO1xuXHRcdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0XHRlZGl0b3JQYXJhbXMuc29mdFdyYXBwZWQgPSB0cnVlO1xuXHRcdFx0XHRcdFx0ZWRpdG9yUGFyYW1zLnNvZnRXcmFwQXRQcmVmZXJyZWRMaW5lTGVuZ3RoID0gdHJ1ZTtcblx0XHRcdFx0XHRcdGVkaXRvclBhcmFtcy5wcmVmZXJyZWRMaW5lTGVuZ3RoID0gc2V0dGluZ3MubWF4X2xpbmVfbGVuZ3RoO1xuXHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdC8vIFVwZGF0ZSB0aGUgZWRpdG9yLXByb3BlcnRpZXNcblx0XHRcdFx0XHRlZGl0b3IudXBkYXRlKGVkaXRvclBhcmFtcyk7XG5cblx0XHRcdFx0XHQvLyBFbnN1cmUgdGhlIHdyYXAtZ3VpZGUgaXMgc2V0IHByb3Blcmx5XG5cdFx0XHRcdFx0aWYgKHRoaXMud3JhcEd1aWRlID09PSB1bmRlZmluZWQpIHtcblx0XHRcdFx0XHRcdHRoaXMud3JhcEd1aWRlID0gbmV3ICh3cmFwR3VpZGUoKSkoKTtcblx0XHRcdFx0XHRcdHRoaXMud3JhcEd1aWRlLmluaXRpYWxpemUoXG5cdFx0XHRcdFx0XHRcdGVkaXRvcixcblx0XHRcdFx0XHRcdFx0YXRvbS52aWV3cy5nZXRWaWV3KGVkaXRvcilcblx0XHRcdFx0XHRcdCk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHRcdHRoaXMud3JhcEd1aWRlLnVwZGF0ZSgpO1xuXHRcdFx0XHRcdC8vIFRvZ2dsZSB0aGUgd3JhcC1ndWlkZSBwYWNrYWdlIGlmIG5lY2Vzc2FyeVxuXHRcdFx0XHRcdHRoaXMuc2V0UGFja2FnZVN0YXRlKCd3cmFwLWd1aWRlJywgdGhpcy53cmFwR3VpZGUuaXNWaXNpYmxlKCkgPT09IGZhbHNlKTtcblxuXHRcdFx0XHRcdGlmIChzZXR0aW5ncy5lbmRfb2ZfbGluZSAhPT0gJ2F1dG8nKSB7XG5cdFx0XHRcdFx0XHRidWZmZXIuc2V0UHJlZmVycmVkTGluZUVuZGluZyhzZXR0aW5ncy5lbmRfb2ZfbGluZSk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9XG5cdFx0XHRcdHNldFN0YXRlKHRoaXMpO1xuXHRcdFx0fSxcblxuXHRcdFx0Ly8gb25XaWxsU2F2ZS1FdmVudC1IYW5kbGVyXG5cdFx0XHQvLyBUcmltcyB3aGl0ZXNwYWNlcyBhbmQgaW5zZXJ0cy9zdHJpcHMgZmluYWwgbmV3bGluZSBiZWZvcmUgc2F2aW5nXG5cdFx0XHRvbldpbGxTYXZlKCkge1xuXHRcdFx0XHRjb25zdCBzZXR0aW5ncyA9IHRoaXMuc2V0dGluZ3M7XG5cblx0XHRcdFx0aWYgKHNldHRpbmdzLnRyaW1fdHJhaWxpbmdfd2hpdGVzcGFjZSA9PT0gdHJ1ZSkge1xuXHRcdFx0XHRcdC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBtYXgtcGFyYW1zXG5cdFx0XHRcdFx0YnVmZmVyLmJhY2t3YXJkc1NjYW4oL1sgXFx0XSskL2dtLCBwYXJhbXMgPT4ge1xuXHRcdFx0XHRcdFx0aWYgKHBhcmFtcy5tYXRjaFswXS5sZW5ndGggPiAwKSB7XG5cdFx0XHRcdFx0XHRcdHBhcmFtcy5yZXBsYWNlKCcnKTtcblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHR9KTtcblx0XHRcdFx0fVxuXG5cdFx0XHRcdGlmIChzZXR0aW5ncy5pbnNlcnRfZmluYWxfbmV3bGluZSAhPT0gJ2F1dG8nKSB7XG5cdFx0XHRcdFx0Y29uc3QgbGFzdFJvdyA9IGJ1ZmZlci5nZXRMaW5lQ291bnQoKSAtIDE7XG5cblx0XHRcdFx0XHRpZiAoYnVmZmVyLmlzUm93QmxhbmsobGFzdFJvdykpIHtcblx0XHRcdFx0XHRcdGxldCBzdHJpcFN0YXJ0ID0gYnVmZmVyLnByZXZpb3VzTm9uQmxhbmtSb3cobGFzdFJvdyk7XG5cblx0XHRcdFx0XHRcdGlmIChzZXR0aW5ncy5pbnNlcnRfZmluYWxfbmV3bGluZSA9PT0gdHJ1ZSkge1xuXHRcdFx0XHRcdFx0XHRzdHJpcFN0YXJ0ICs9IDE7XG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHQvLyBTdHJpcCBlbXB0eSBsaW5lcyBmcm9tIHRoZSBlbmRcblx0XHRcdFx0XHRcdGlmIChzdHJpcFN0YXJ0IDwgbGFzdFJvdykge1xuXHRcdFx0XHRcdFx0XHRidWZmZXIuZGVsZXRlUm93cyhzdHJpcFN0YXJ0ICsgMSwgbGFzdFJvdyk7XG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0fSBlbHNlIGlmIChzZXR0aW5ncy5pbnNlcnRfZmluYWxfbmV3bGluZSA9PT0gdHJ1ZSkge1xuXHRcdFx0XHRcdFx0YnVmZmVyLmFwcGVuZCgnXFxuJyk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0fTtcblxuXHRcdGJ1ZmZlci5lZGl0b3Jjb25maWcuZGlzcG9zYWJsZXMuYWRkKFxuXHRcdFx0YnVmZmVyLm9uV2lsbFNhdmUoYnVmZmVyLmVkaXRvcmNvbmZpZy5vbldpbGxTYXZlLmJpbmQoYnVmZmVyLmVkaXRvcmNvbmZpZykpXG5cdFx0KTtcblx0XHRpZiAoYnVmZmVyLmdldFVyaSgpICYmIGJ1ZmZlci5nZXRVcmkoKS5tYXRjaCgvW1xcXFx8L11cXC5lZGl0b3Jjb25maWckL2cpICE9PSBudWxsKSB7XG5cdFx0XHRidWZmZXIuZWRpdG9yY29uZmlnLmRpc3Bvc2FibGVzLmFkZChcblx0XHRcdFx0YnVmZmVyLm9uRGlkU2F2ZShyZWFwcGx5RWRpdG9yY29uZmlnKVxuXHRcdFx0KTtcblx0XHR9XG5cdH1cbn1cblxuLy8gUmV2ZWFsIGFuZCBhcHBseSB0aGUgZWRpdG9yY29uZmlnIGZvciB0aGUgZ2l2ZW4gVGV4dEVkaXRvci1pbnN0YW5jZVxuZnVuY3Rpb24gb2JzZXJ2ZVRleHRFZGl0b3IoZWRpdG9yKSB7XG5cdGlmICghZWRpdG9yKSB7XG5cdFx0cmV0dXJuO1xuXHR9XG5cdGluaXRpYWxpemVUZXh0QnVmZmVyKGVkaXRvci5nZXRCdWZmZXIoKSk7XG5cblx0Y29uc3QgZmlsZSA9IGVkaXRvci5nZXRVUkkoKTtcblx0aWYgKCFmaWxlKSB7XG5cdFx0ZWRpdG9yLm9uRGlkU2F2ZSgoKSA9PiB7XG5cdFx0XHRvYnNlcnZlVGV4dEVkaXRvcihlZGl0b3IpO1xuXHRcdH0pO1xuXHRcdHJldHVybjtcblx0fVxuXG5cdGVkaXRvcmNvbmZpZygpLnBhcnNlKGZpbGUpLnRoZW4oY29uZmlnID0+IHtcblx0XHRpZiAoT2JqZWN0LmtleXMoY29uZmlnKS5sZW5ndGggPT09IDApIHtcblx0XHRcdHJldHVybjtcblx0XHR9XG5cblx0XHRjb25zdCBlY2ZnID0gZWRpdG9yLmdldEJ1ZmZlcigpLmVkaXRvcmNvbmZpZztcblx0XHRjb25zdCBzZXR0aW5ncyA9IGVjZmcuc2V0dGluZ3M7XG5cdFx0Y29uc3QgbGluZUVuZGluZ3MgPSB7XG5cdFx0XHRjcmxmOiAnXFxyXFxuJyxcblx0XHRcdGNyOiAnXFxyJyxcblx0XHRcdGxmOiAnXFxuJ1xuXHRcdH07XG5cblx0XHQvLyBQcmVzZXJ2ZSBldmFsdWF0ZWQgRWRpdG9yY29uZmlnXG5cdFx0ZWNmZy5jb25maWcgPSBjb25maWc7XG5cblx0XHQvLyBDYXJlZnVsbHkgbm9ybWFsaXplIGFuZCBpbml0aWFsaXplIGNvbmZpZy1zZXR0aW5nc1xuXHRcdC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBjYW1lbGNhc2Vcblx0XHRzZXR0aW5ncy50cmltX3RyYWlsaW5nX3doaXRlc3BhY2UgPSAoJ3RyaW1fdHJhaWxpbmdfd2hpdGVzcGFjZScgaW4gY29uZmlnKSAmJlxuXHRcdFx0dHlwZW9mIGNvbmZpZy50cmltX3RyYWlsaW5nX3doaXRlc3BhY2UgPT09ICdib29sZWFuJyA/XG5cdFx0XHRjb25maWcudHJpbV90cmFpbGluZ193aGl0ZXNwYWNlID09PSB0cnVlIDpcblx0XHRcdCdhdXRvJztcblxuXHRcdC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBjYW1lbGNhc2Vcblx0XHRzZXR0aW5ncy5pbnNlcnRfZmluYWxfbmV3bGluZSA9ICgnaW5zZXJ0X2ZpbmFsX25ld2xpbmUnIGluIGNvbmZpZykgJiZcblx0XHRcdHR5cGVvZiBjb25maWcuaW5zZXJ0X2ZpbmFsX25ld2xpbmUgPT09ICdib29sZWFuJyA/XG5cdFx0XHRjb25maWcuaW5zZXJ0X2ZpbmFsX25ld2xpbmUgPT09IHRydWUgOlxuXHRcdFx0J2F1dG8nO1xuXG5cdFx0Ly8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGNhbWVsY2FzZVxuXHRcdHNldHRpbmdzLmluZGVudF9zdHlsZSA9ICgoJ2luZGVudF9zdHlsZScgaW4gY29uZmlnKSAmJlxuXHRcdFx0Y29uZmlnLmluZGVudF9zdHlsZS5zZWFyY2goL14oc3BhY2V8dGFiKSQvKSA+IC0xKSA/XG5cdFx0XHRjb25maWcuaW5kZW50X3N0eWxlIDpcblx0XHRcdCdhdXRvJztcblxuXHRcdC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBjYW1lbGNhc2Vcblx0XHRzZXR0aW5ncy5lbmRfb2ZfbGluZSA9IGxpbmVFbmRpbmdzW2NvbmZpZy5lbmRfb2ZfbGluZV0gfHwgJ2F1dG8nO1xuXG5cdFx0Ly8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGNhbWVsY2FzZVxuXHRcdHNldHRpbmdzLnRhYl93aWR0aCA9IHBhcnNlSW50KGNvbmZpZy5pbmRlbnRfc2l6ZSB8fCBjb25maWcudGFiX3dpZHRoLCAxMCk7XG5cdFx0aWYgKGlzTmFOKHNldHRpbmdzLnRhYl93aWR0aCkgfHwgc2V0dGluZ3MudGFiX3dpZHRoIDw9IDApIHtcblx0XHRcdHNldHRpbmdzLnRhYl93aWR0aCA9ICdhdXRvJzsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBjYW1lbGNhc2Vcblx0XHR9XG5cblx0XHQvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgY2FtZWxjYXNlXG5cdFx0c2V0dGluZ3MubWF4X2xpbmVfbGVuZ3RoID0gcGFyc2VJbnQoY29uZmlnLm1heF9saW5lX2xlbmd0aCwgMTApO1xuXHRcdGlmIChpc05hTihzZXR0aW5ncy5tYXhfbGluZV9sZW5ndGgpIHx8IHNldHRpbmdzLm1heF9saW5lX2xlbmd0aCA8PSAwKSB7XG5cdFx0XHRzZXR0aW5ncy5tYXhfbGluZV9sZW5ndGggPSAnYXV0byc7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgY2FtZWxjYXNlXG5cdFx0fVxuXG5cdFx0c2V0dGluZ3MuY2hhcnNldCA9ICgnY2hhcnNldCcgaW4gY29uZmlnKSA/XG5cdFx0XHRjb25maWcuY2hhcnNldC5yZXBsYWNlKC8tL2csICcnKS50b0xvd2VyQ2FzZSgpIDpcblx0XHRcdCdhdXRvJztcblxuXHRcdGVjZmcuYXBwbHlTZXR0aW5ncygpO1xuXHR9KS5jYXRjaChFcnJvciwgZSA9PiB7XG5cdFx0Y29uc29sZS53YXJuKGBhdG9tLWVkaXRvcmNvbmZpZzogJHtlfWApO1xuXHR9KTtcbn1cblxuLy8gUmVhcHBsaWVzIHRoZSB3aG9sZSBlZGl0b3Jjb25maWcgdG8gKiphbGwqKiBvcGVuIFRleHRFZGl0b3ItaW5zdGFuY2VzXG5mdW5jdGlvbiByZWFwcGx5RWRpdG9yY29uZmlnKCkge1xuXHRjb25zdCB0ZXh0RWRpdG9ycyA9IGF0b20ud29ya3NwYWNlLmdldFRleHRFZGl0b3JzKCk7XG5cdHRleHRFZGl0b3JzLmZvckVhY2goZWRpdG9yID0+IHtcblx0XHRvYnNlcnZlVGV4dEVkaXRvcihlZGl0b3IpO1xuXHR9KTtcbn1cblxuLy8gUmVhcHBsaWVzIHRoZSBzZXR0aW5ncyBpbW1lZGlhdGVseSBhZnRlciBjaGFuZ2luZyB0aGUgZm9jdXMgdG8gYSBuZXcgcGFuZVxuZnVuY3Rpb24gb2JzZXJ2ZUFjdGl2ZVBhbmVJdGVtKGVkaXRvcikge1xuXHRpZiAoZWRpdG9yICYmIGVkaXRvci5jb25zdHJ1Y3Rvci5uYW1lID09PSAnVGV4dEVkaXRvcicpIHtcblx0XHRpZiAoZWRpdG9yLmdldEJ1ZmZlcigpLmVkaXRvcmNvbmZpZykge1xuXHRcdFx0ZWRpdG9yLmdldEJ1ZmZlcigpLmVkaXRvcmNvbmZpZy5hcHBseVNldHRpbmdzKCk7XG5cdFx0fVxuXHR9IGVsc2Uge1xuXHRcdHN0YXR1c1RpbGUoKS5yZW1vdmVJY29uKCk7XG5cdH1cbn1cblxuLy8gSG9vayBpbnRvIHRoZSBldmVudHMgdG8gcmVjb2duaXplIHRoZSB1c2VyIG9wZW5pbmcgbmV3IGVkaXRvcnMgb3IgY2hhbmdpbmcgdGhlIHBhbmVcbmNvbnN0IGFjdGl2YXRlID0gKCkgPT4ge1xuXHRnZW5lcmF0ZUNvbmZpZygpO1xuXHRzaG93U3RhdGUoKTtcblx0Zml4RmlsZSgpO1xuXHRhdG9tLndvcmtzcGFjZS5vYnNlcnZlVGV4dEVkaXRvcnMob2JzZXJ2ZVRleHRFZGl0b3IpO1xuXHRhdG9tLndvcmtzcGFjZS5vYnNlcnZlQWN0aXZlUGFuZUl0ZW0ob2JzZXJ2ZUFjdGl2ZVBhbmVJdGVtKTtcbn07XG5cbi8vIENsZWFuIHRoZSBzdGF0dXMtaWNvbiB1cCwgcmVtb3ZlIGFsbCBlbWJlZGRlZCBlZGl0b3Jjb25maWctb2JqZWN0c1xuY29uc3QgZGVhY3RpdmF0ZSA9ICgpID0+IHtcblx0Y29uc3QgdGV4dEVkaXRvcnMgPSBhdG9tLndvcmtzcGFjZS5nZXRUZXh0RWRpdG9ycygpO1xuXHR0ZXh0RWRpdG9ycy5mb3JFYWNoKGVkaXRvciA9PiB7XG5cdFx0ZWRpdG9yLmdldEJ1ZmZlcigpLmVkaXRvcmNvbmZpZy5kaXNwb3NhYmxlcy5kaXNwb3NlKCk7XG5cdH0pO1xuXHRzdGF0dXNUaWxlKCkucmVtb3ZlSWNvbigpO1xufTtcblxuLy8gQXBwbHkgdGhlIHN0YXR1c2JhciBpY29uLWNvbnRhaW5lclxuLy8gVGhlIGljb24gd2lsbCBiZSBhcHBsaWVkIGlmIG5lZWRlZFxuY29uc3QgY29uc3VtZVN0YXR1c0JhciA9IHN0YXR1c0JhciA9PiB7XG5cdGlmIChzdGF0dXNUaWxlKCkuY29udGFpbmVyRXhpc3RzKCkgPT09IGZhbHNlKSB7XG5cdFx0c3RhdHVzQmFyLmFkZFJpZ2h0VGlsZSh7XG5cdFx0XHRpdGVtOiBzdGF0dXNUaWxlKCkuY3JlYXRlQ29udGFpbmVyKCksXG5cdFx0XHRwcmlvcml0eTogOTk5XG5cdFx0fSk7XG5cdH1cbn07XG5cbmV4cG9ydCBkZWZhdWx0IHthY3RpdmF0ZSwgZGVhY3RpdmF0ZSwgY29uc3VtZVN0YXR1c0Jhcn07XG4iXX0=